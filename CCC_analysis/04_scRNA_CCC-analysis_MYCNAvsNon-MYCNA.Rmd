---
title: "CCC analysis: MNA vs. non-MNA"
author: "Sara Wernig-Zorc"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    toc_depth: 5
    toc_float: yes
    collapsed: false
    code_folding: hide
    highlight: pygments
    theme: spacelab
    df_print: paged
params:
  input: "/home/data/MapMet/"
  out: "/home/out/MapMet/"
  GO_db: "/home/sara_wz/annotation/GSEA_GeneSetEnrichments"
  markers: "/home/sara_wz/annotation/MES_ADRN/"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      error = FALSE, 
                      messages = FALSE,
                      warning = FALSE)

library(parallel)
future::plan(strategy = 'future::multicore', workers = 12)
options(future.globals.maxSize = 8 * 10^9)

source("/home/sara_wz/MapMet_project/MapMetSC/code/R/CCC_analysis/00_MapMet_color_code.R")

print(params)
```

```{r libs}
library(Seurat)
library(SingleCellExperiment)
library(dplyr)
library(ggplot2)
library(nichenetr)
library(multinichenetr)
library(SCpubr)
library(igraph)
```

# ___Load data___

```{r load Fetahu2023 dataset}
metadata <- readRDS(paste0(params$input,"/fetahu.scRNA.2023/data/metadata.rds"))
scrna_data <- readRDS(paste0(params$input,"/fetahu.scRNA.2023/data/rna_decontaminated.rds"))

rna <- as.Seurat(scrna_data, data=NULL)
rna <- RenameAssays(object = rna, originalexp = 'RNA')

rna@active.ident <- setNames(pull(metadata[match(metadata$cell,colnames(rna)),"cellont_cluster"], "cellont_cluster"),pull(metadata[match(metadata$cell,colnames(rna)), "cell"], "cell"))
DefaultAssay(rna) <- "RNA"

true_label <- rna@active.ident

rna$original_celltype <- rna@active.ident

rna@meta.data
```

# ___Figure 5, H: UMAP gene expression___

```{r}
genes.to.plot <- c("CD274","PDCD1","CD8A","CD4","GZMB","S100B")


figure5h_1 <- SCpubr::do_DimPlot(rna,
                                 border.color = "black",
                                 plot_cell_borders = TRUE,
                                 reduction = "UMAP",
                                 colors.use =  COLOR_CODE_RNA_v3_EXT,
                                 repel = TRUE,
                                 font.size = 14,
                                 label.size  = 14,
                                 plot.axes = TRUE,
                                 label = FALSE,
                                 legend.title = "Clusters",
                                 plot.title = "UMAP",
                                 legend.position = "right")


figure5h2_7_v1 <- SCpubr::do_FeaturePlot(sample = rna,
                                         reduction = "UMAP",
                                         features = genes.to.plot,
                                         order = TRUE,
                                         enforce_symmetry = TRUE,
                                         label = FALSE,
                                         font.size = 14,
                                         diverging.palette = "PRGn",
                                         legend.title = "Gene expression",
                                         plot.axes = TRUE,
                                         slot = "data")


figure5h2_7_v2 <- SCpubr::do_FeaturePlot(sample = rna,
                                      reduction = "UMAP",
                                      features = genes.to.plot,
                                      order = TRUE,
                                      enforce_symmetry = TRUE,
                                      label = FALSE,
                                      font.size = 14,
                                      diverging.palette = "PuOr", 
                                      legend.title = "Gene expression",
                                      plot.axes = TRUE,
                                      slot = "data")

figure5h_1  
figure5h2_7_v1

# save plots PART I 
pdf(paste0(params$out,"figures/Figure5-H_PART_1_UMAP_final.pdf"),
    height = 5, width = 8)
figure5h_1
dev.off()

png(paste0(params$out,"figures/Figure5-H_PART_1_UMAP_final.png"),
    height = 400, width = 600)
figure5h_1
dev.off()

# save plots PART II
pdf(paste0(params$out,"figures/Figure5-H_PART_2_UMAP_final.pdf"),
    height = 15 ,width = 10)
figure5h2_7_v1
dev.off()

png(paste0(params$out,"figures/Figure5-H_PART_2_UMAP_final.png"),
    height = 1500,width = 1000)
figure5h2_7_v1
dev.off()

pdf(paste0(params$out,"figures/Figure5-H_PART_2_UMAP_final_v2.pdf"),
    height = 15 ,width = 10)
figure5h2_7_v2
dev.off()

png(paste0(params$out,"figures/Figure5-H_PART_2_UMAP_final_v2.png"),
    height = 1500,width = 1000)
figure5h2_7_v2
dev.off()


```


# ___Define comparison groups___

Comparison: MYCN amplified vs. non-MYCN amplified
Cell types of inetrest: T-cells, Monocytes and tumor cells

```{r define comparison groups and clusters of interest, eval=FALSE, include=FALSE}
# STEP 1
Idents(rna) <- rna@meta.data$original_celltype

# define which clusters to compare
clusters_of_interest <- c("T (5)", "T (6)", "T (9)", 
                          "M (1)", "M (2)", "M (10)", 
                          "NB (8)") 
# Clusters T (18) and M (15) were excluded due to low cell numbers (<100)

rna_subset <- subset(rna, idents = clusters_of_interest, invert = FALSE)

# remove control samples

Idents(rna_subset) <- rna@meta.data$group

MNA_patients <- "II"
nMNA_patients <- c("III","IV")
control_patients <- "I"

rna_subset@meta.data$new_groups <- NA
rna_subset@meta.data <- rna_subset@meta.data %>% 
  mutate(new_groups = ifelse((rna_subset@meta.data$group == "II" ),  
                             "MNA","nMNA"))

rna@meta.data$case_control <- NA
rna@meta.data <- rna@meta.data %>% 
  mutate(case_control = ifelse((rna@meta.data$group == "I"),  
                             "CTRL","NB"))

table(rna@meta.data$case_control)
table(rna@meta.data$new_groups)
table(rna@meta.data$original_celltype)

saveRDS(rna_subset, file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB.Rds")

# STEP 2

MNA <- subset(rna_subset, idents = MNA_patients, invert = FALSE)
nMNA <- subset(rna_subset, idents = nMNA_patients, invert = FALSE)
control <- subset(rna_subset, idents = control_patients, invert = FALSE)

table(MNA@meta.data$group)
table(nMNA@meta.data$group)
table(control@meta.data$group)


# STEP 3
Idents(MNA) <- MNA@meta.data$original_celltype
Idents(nMNA) <- nMNA@meta.data$original_celltype
Idents(control) <- control@meta.data$original_celltype

# STEP 4
MNA$original_celltype = droplevels(MNA$original_celltype, 
                                     exclude = setdiff(levels(MNA$original_celltype),
                                                       unique(MNA$original_celltype)))

nMNA$original_celltype = droplevels(nMNA$original_celltype, 
                                        exclude = setdiff(levels(nMNA$original_celltype),
                                                          unique(nMNA$original_celltype)))

control$original_celltype = droplevels(control$original_celltype, 
                                     exclude = setdiff(levels(control$original_celltype),
                                                       unique(control$original_celltype)))


saveRDS(MNA, file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_MNA.Rds")
saveRDS(nMNA, file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_nMNA.Rds")
saveRDS(control, file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_control.Rds")

# STEP 5
rna_CTRL <- subset(rna_subset, idents = control_patients, invert = TRUE) # remove controls
metadata <- rna_CTRL@meta.data

saveRDS(rna_CTRL, file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_noCTRL.Rds")
```

```{r load Rds}
rna_noCTRL <- readRDS(file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_noCTRL.Rds")
Idents(rna_noCTRL) <- rna_noCTRL@meta.data$original_celltype

rna_wCTRL <- readRDS(file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB.Rds")
Idents(rna_wCTRL) <- rna_wCTRL@meta.data$original_celltype

MNA <- readRDS(file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_MNA.Rds")
nMNA <- readRDS(file = "/home/out/MapMet/Rds/fetahu2023_T_MO_NB_nMNA.Rds")

table(rna@meta.data$case_control)
table(rna@meta.data$new_groups)
table(rna@meta.data$original_celltype)
```

# ___Figure 5, I: Dotplot of T-cell functional markers___

```{r}
library(RColorBrewer)
color_pallet <- colorRampPalette(colors = c("gray", "pink","#7f0d71"))(10)
scales::show_col(color_pallet[4:10])


clusters_to_plot <- c("T (5)", "T (6)", "T (9)", "NB (8)")
tcells_tumorcells <- subset(rna, idents = clusters_to_plot, invert = FALSE)

genes <- list("Canonical 
              markers" = c("CD4","CD8A","GZMB","S100B","PDCD1","CD274"),
              "Exhaustion
              markers" = c("LAG3","CTLA4", "IL10RA","PRDM1",
                           "TIGIT","HAVCR2","BATF","NFATC3", #also tumor reactivity   
                           "NFAT5","KLRG1","CD160", "IKZF2","TBX21", 
                           "CD244","EOMES"),
              "Activation
              markers" = c("PTPRC","CD27","CD69","CCR7"))


dotplot_final <- SCpubr::do_DotPlot(sample = tcells_tumorcells, 
                                    plot.title = "\t \t \t \t \t T-cell markers",
                                    features = genes,
                                    font.size = 14,
                                    flip = FALSE,
                                    number.breaks = 20,
                                    use_viridis = TRUE,
                                    viridis.palette =  "inferno")
dotplot_final


pdf(paste0(params$out,"figures/Figure5-I_DotPlot_final.pdf"),
    width = 10,height = 5)
dotplot_final
dev.off()

png(paste0(params$out,"figures/Figure5-I_DotPlot_final.png"),
    width = 700,height = 300)
dotplot_final
dev.off()
```

# ___Figure 7, A: UMAP vizualization per group___

```{r Figure 7-A,  fig.height=5, fig.width=18}
Idents(rna) <-  rna$original_celltype

combined_umap <- DimPlot(rna, cols = COLOR_CODE_RNA_v3, seed = 28, shuffle = TRUE) + 
  ggtitle(label = "all samples") + NoLegend() +  
  theme(text = element_text(size = 20), axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18)) # n = 26726 cells
mycn_umap <- DimPlot(MNA, cols = COLOR_CODE_RNA_v3, seed = 28, shuffle = TRUE) + 
  ggtitle(label = "MNA") + NoLegend() +  
  theme(text = element_text(size = 20), axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18)) # n = 10155 cells
non_mycn_umap <- DimPlot(nMNA, cols = COLOR_CODE_RNA_v3, seed = 28, shuffle = TRUE) + 
  ggtitle(label = "nMNA") +  
  theme(text = element_text(size = 20), axis.text.x = element_text(size = 18),
        axis.text.y = element_text(size = 18))  # n = 16571  cells

# show plots
combined_umap + mycn_umap + non_mycn_umap  

# save plots
pdf("/home/out/MapMet/Figures/fetahu2023_UMAPs_MNA_nMNA.pdf",
    height = 7, width = 21)
combined_umap + mycn_umap + non_mycn_umap  
dev.off()

png(filename = "/home/out/MapMet/Figures/fetahu2023_UMAPs_MNA_nMNA.png",
    width = 2100, height = 700, units = "px", pointsize = 1, res = 150)
combined_umap + mycn_umap + non_mycn_umap  
dev.off()

tiff(filename = "/home/out/MapMet/Figures/fetahu2023_UMAPs_MNA_nMNA.tiff",
      width = 2100, height = 700, units = "px", res = 150, pointsize = 1)
combined_umap + mycn_umap + non_mycn_umap  
dev.off()
```


# ___Figure 7, B: CCC analysis with CellChat___

To infer the cell state-specific communications, CellChat v2 identifies 
over-expressed ligands or receptors in one cell group and then identifies 
over-expressed ligand-receptor interactions if either ligand or receptor are 
over-expressed.

```{r ccc function - basic, include=FALSE, eval=FALSE}
ccc.analysis <- function(seurat) {
  print(seurat)
  Idents(seurat) <- seurat@meta.data$original_celltype
  # extract read count matrix
  mat <- GetAssayData(seurat, assay = "RNA", slot = "data")
  # create cell chat object
  cellchat <- createCellChat(
    mat, meta = seurat@meta.data,
    group.by = "original_celltype",
)
  # define which database to use
  cellchat@DB <- CellChatDB.human
  # only keep genes in CellChatDB
  cellchat <- subsetData(cellchat)
  # find over expressed ligands/receptors
  cellchat <- identifyOverExpressedGenes(cellchat)
  # find over expressed interactions
  cellchat <- identifyOverExpressedInteractions(cellchat)
  # calculate communication probability between cell groups
  cellchat <- computeCommunProb(cellchat, seed.use = 28)
  # filter communications occurring with less than 100 cells in a cell group
  cellchat <- filterCommunication(cellchat,min.cells = 100)
  # calculate communication probability on the signaling pathway level
  cellchat <- computeCommunProbPathway(cellchat)
  # calculate aggregated communication network
  cellchat <- aggregateNet(cellchat)
  # determine network centrality pathways
  cellchat <- netAnalysis_computeCentrality(cellchat)
  # save analysis results
  df_net_all <-
  cellchat %>% 
  subsetCommunication() %>% 
  as_tibble() %>% 
  group_by(interaction_name_2) %>% 
  mutate(prob.norm = prob / max(prob)) %>% # Normalize the probabilities 0-1
  ungroup() %>% 
  mutate(
    source = factor(source, clusters_of_interest),
    target = factor(target, clusters_of_interest),
    )
  df_net_all
  # print results
  print(df_net_all)
  # save results in Rds object
  #cellchat %>% 
  #saveRDS("/home/out/MapMet/Rds/fetahu2023.cellchat",seurat,".Rds"))
  #df_net_all %>% 
  #saveRDS("/home/out/MapMet/Rds/fetahu2023.signaling",seurat,".Rds"))
  }
```

```{r Run basic CCC analysis, eval=FALSE, include=FALSE}
sample.list <- list(MNA, nMNA)
setNames(sample.list, c("MNA", "nMNA"))

CCC_analysis <- lapply(sample.list, ccc.analysis)

saveRDS(CCC_analysis, file = paste0(params$out,"Rds/CCC_analysis_basic.Rds"))
```

```{r set a cutoff I, eval=FALSE, include=FALSE}
# set a cutoff
hist(CCC_analysis[[1]]$prob.norm)
hist(CCC_analysis[[2]]$prob.norm)
```

```{r Save CCC basic results, eval=FALSE, include=FALSE}
CCC_analysis[[1]]
write.csv(CCC_analysis[[1]], file = "/home/out/MapMettables/CellChat_MNA_CCC_basic.csv",
          quote = FALSE,sep = "\t",row.names = FALSE)
CCC_analysis[[2]]
write.csv(CCC_analysis[[2]], file = "/home/out/MapMettables/CellChat_nMNA_CCC_basic.csv",
          quote = FALSE,sep = "\t",row.names = FALSE)
#CCC_analysis[[3]]
#write.csv(CCC_analysis[[1]], file = "/home/out/MapMettables/CellChat_controls_CCC_basic.csv"),
#          quote = FALSE,sep = "\t",row.names = FALSE)
```

```{r ccc function - advanced}
ccc.analysis.comprehensive <- function(seurat) {
  n = n + 1
  print(seurat)
  print("Loop number: ", n)
  
  Idents(seurat) <- seurat@meta.data$original_celltype
  # extract read count matrix
  mat <- GetAssayData(seurat, assay = "RNA", slot = "data")
  # create cell chat object
  cellchat <- createCellChat(mat, 
                             meta = seurat@meta.data,
                             group.by = "original_celltype",
                             )
  
  
  
  # Prepare DB
  cellchat@DB <- CellChatDB.human
  # subset the expression data of signaling genes for saving computation cost
  cellchat <- subsetData(cellchat) # This step is necessary even if using the whole database (it removes genes which are not expressed in the data)
  cellchat <- identifyOverExpressedGenes(cellchat)
  cellchat <- identifyOverExpressedInteractions(cellchat)
  cellchat <- projectData(cellchat, PPI.human)
  # Compute the communication probability and infer cellular communication network
  # project gene expression data onto PPI (Use `raw.use = FALSE` in the function 
  # computeCommunProb() in order to use the projected data)
  cellchat <- computeCommunProb(cellchat, raw.use = FALSE, population.size = TRUE)
  # population.size = TRUE <- cell numbers per cell type/cluster 
  # used for the probability calculation
  # only consider R-L pairs which are expressed by minumum 50 cells
  cellchat <- filterCommunication(cellchat, min.cells = 50)
  df.net <- subsetCommunication(cellchat)
  df.net.pathways <- subsetCommunication(cellchat, slot.name = "netP")
  # slot.name = "netP" for inferred communications at the level of signaling pathways
  print(df.net.pathways)
  # Infer the cell-cell communication at a signaling pathway level
  cellchat <- computeCommunProbPathway(cellchat)
  # Calculate the aggregated cell-cell communication network
  cellchat <- aggregateNet(cellchat)
  groupSize <- as.numeric(table(cellchat@idents))
  
  circo_plot <- netVisual_circle(cellchat@net$weight, 
                                 vertex.weight = groupSize, 
                                 weight.scale = T, 
                                 label.edge = F, 
                                 title.name = "CC interaction strength",
                                 color.use = COLOR_CODE_RNA_v3)
  print(circo_plot)
  
  pdf(paste0(params$out,"figures/Figure7-B_final_",n,".pdf"),
    height = 5, width = 8)
  circo_plot
  dev.off()
  
  # Bubble plot: all the significant interactions (Ligand-Receptor pairs) from 
  # one cell groups (defined by 'sources.use') to other cell groups (defined by 'targets.use')
  netVisual_bubble(cellchat, sources.use = "NB (8)",  
                   remove.isolate = FALSE)
  netVisual_chord_gene(cellchat, sources.use = "NB (8)", 
                       slot.name = "netP", 
                       legend.pos.x = 10)
  # Compute the network centrality scores
  cellchat <- netAnalysis_computeCentrality(cellchat, slot.name = "netP") 
  # the slot 'netP' means the inferred intercellular communication network of signaling pathways
  # Visualize the computed centrality scores using heatmap, allowing ready identification of major signaling roles of cell groups
  #netAnalysis_signalingRole_network(cellchat, signaling = pathway, 
  #                                  width = 8, height = 2.5, font.size = 12)
  # Visualize dominant senders (sources) and receivers (targets) in a 2D space
  gg1 <- netAnalysis_signalingRole_scatter(cellchat)
  # Signaling role analysis on the cell-cell communication networks of interest
  #gg2 <- netAnalysis_signalingRole_scatter(cellchat, signaling = pathway)
  # Signaling role analysis on the cell-cell communication network from user's input
  print(gg1)
  #gg2
  # Signaling role analysis on the aggregated cell-cell communication network from all signaling pathways
  ht1 <- netAnalysis_signalingRole_heatmap(cellchat, pattern = "outgoing",color.use = COLOR_CODE_RNA_v3)
  ht2 <- netAnalysis_signalingRole_heatmap(cellchat, pattern = "incoming",color.use = COLOR_CODE_RNA_v3)
  print(ht1 + ht2)
  # run selectK to infer the number of patterns.
  # selectK(cellchat, pattern = "outgoing") # define the number of patterns/cut-off
  nPatterns = 7 # based on the output of the previous command
  cellchat <- identifyCommunicationPatterns(cellchat, 
                                            pattern = "outgoing", 
                                            k = nPatterns)
  # river plot
  netAnalysis_river(cellchat, pattern = "outgoing",color.use = COLOR_CODE_RNA_v3)
  # dot plot
  netAnalysis_dot(cellchat, pattern = "outgoing",color.use = COLOR_CODE_RNA_v3)
  # the same for incoming communication patterns
  #selectK(cellchat, pattern = "incoming") # define the number of patterns/cut-off
  nPatterns = 7
  cellchat <- identifyCommunicationPatterns(cellchat, 
                                            pattern = "incoming", 
                                            k = nPatterns)
  # river plot
  netAnalysis_river(cellchat, pattern = "incoming",color.use = COLOR_CODE_RNA_v3)
  # dot plot
  netAnalysis_dot(cellchat, pattern = "incoming",color.use = COLOR_CODE_RNA_v3)
  #saveRDS(cellchat, file = "/home/out/MapMetRds/CCC_analysis_Fetahu2023.Rds"))
  results_network <- subsetCommunication(cellchat, slot.name = "net")
  results_pathways <- subsetCommunication(cellchat, slot.name = "netP")
  
  df_net_all <-
  cellchat %>% 
  subsetCommunication() %>% 
  as_tibble() %>% 
  group_by(interaction_name_2) %>% 
  mutate(prob.norm = prob / max(prob)) %>% # Normalize the probabilities 0-1
  ungroup() %>% 
  mutate(
    source = factor(source, clusters_of_interest),
    target = factor(target, clusters_of_interest),
    )
  
  print(df_net_all)
}
```

```{r Run comprehensive CCC analysis}
n = 0

sample.list <- list(MNA, nMNA)
setNames(sample.list, c("MNA", "nMNA"))

CCC_analysis_full <- lapply(sample.list, ccc.analysis.comprehensive)

saveRDS(CCC_analysis_full, file = paste0(params$out,"Rds/CCC_analysis_full.Rds"))
```

```{r set a cutoff II}
# set a cutoff
hist(CCC_analysis_full[[1]]$prob.norm)
hist(CCC_analysis_full[[2]]$prob.norm)
```

```{r Save CCC comprehensive results}
CCC_analysis_full[[1]]  #MNA
write.csv(CCC_analysis_full[[1]], file = "/home/out/MapMet/tables/CellChat_MNA_CCC_advanced.csv",
          quote = FALSE,sep = "\t",row.names = FALSE)
CCC_analysis_full[[2]]  #non-MNA
write.csv(CCC_analysis_full[[1]], file = "/home/out/MapMet/tables/CellChat_nMNA_CCC_advanced.csv",
          quote = FALSE,sep = "\t",row.names = FALSE)
```

```{r ccc function for the publication}
ccc.publication <- function(seurat) {
  count <- count + 1
  print(seurat)
  print(paste0("Loop number: ", count))
  
  Idents(seurat) <- seurat@meta.data$original_celltype
  # extract read count matrix
  mat <- GetAssayData(seurat, assay = "RNA", slot = "data")
  # create cell chat object
  cellchat <- createCellChat(mat, 
                             meta = seurat@meta.data,
                             group.by = "original_celltype",
                             )

  cellchat@DB <- CellChatDB.human
  cellchat <- subsetData(cellchat) 
  cellchat <- identifyOverExpressedGenes(cellchat)
  cellchat <- identifyOverExpressedInteractions(cellchat)
  cellchat <- projectData(cellchat, 
                          PPI.human)
  cellchat <- computeCommunProb(cellchat, 
                                raw.use = TRUE, 
                                population.size = TRUE)
  cellchat <- filterCommunication(cellchat, min.cells = 50)
  df.net <- subsetCommunication(cellchat)
  df.net.pathways <- subsetCommunication(cellchat, slot.name = "netP")
  print(df.net.pathways)
  cellchat <- computeCommunProbPathway(cellchat)
  cellchat <- aggregateNet(cellchat)
  groupSize <- as.numeric(table(cellchat@idents))
  circo_plot <- netVisual_circle(cellchat@net$weight, 
                                 vertex.weight = groupSize, 
                                 weight.scale = T, 
                                 label.edge = F, 
                                 title.name = "CC interaction strength",
                                 color.use = COLOR_CODE_RNA_v3)
  print(circo_plot)
  
  pdf(paste0(params$out,"figures/Figure7-B_final_",n,".pdf"),
    height = 5, width = 8)
  circo_plot
  dev.off()
}
```

```{r final circos plots}
count = 0

sample.list <- list(MNA, nMNA)
setNames(sample.list, c("MNA", "nMNA"))

CCC_analysis_full <- lapply(sample.list, ccc.publication)
```

#  ___Figure 7, C-D: diffCCC analysis___

## ___CCC analysis with NicheNetR___

common CCC between all Neuroblastomas

```{r prepare DB}
organism <- "human"

if(organism == "human"){
  lr_network <- readRDS(url("https://zenodo.org/record/7074291/files/lr_network_human_21122021.rds"))
  ligand_target_matrix <- readRDS(url("https://zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final.rds"))
  weighted_networks <- readRDS(url("https://zenodo.org/record/7074291/files/weighted_networks_nsga2r_final.rds"))
} else if(organism == "mouse"){
  lr_network <- readRDS(url("https://zenodo.org/record/7074291/files/lr_network_mouse_21122021.rds"))
  ligand_target_matrix <- readRDS(url("https://zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final_mouse.rds"))
  weighted_networks <- readRDS(url("https://zenodo.org/record/7074291/files/weighted_networks_nsga2r_final_mouse.rds"))

}

lr_network <- lr_network %>% distinct(from, to)
```

```{r get_lfc_celltype function}
# rewrite the "get_lfc_celltype" function, as the select function from dplyr R package is causing issues (i explicitly write the name of the package in the function, otherwise i get an error that select cannot be applied to this object)
get_lfc_celltype <- function(celltype_oi, seurat_obj, 
                              condition_colname, condition_oi, 
                              condition_reference, celltype_col = "celltype", ...) {
  seuratObj_sender = subset(seurat_obj, idents = celltype_oi)
  seuratObj_sender = SetIdent(seuratObj_sender, 
                              value = seuratObj_sender[[condition_colname, 
                                                        drop = TRUE]])
  DE_table_sender = FindMarkers(object = seuratObj_sender, 
    ident.1 = condition_oi, ident.2 = condition_reference, random.seed = 28,
    min.cells.group = 50, logfc.threshold = logfc.threshold, min.pct = min.pct) %>% rownames_to_column("gene")
  DE_table_sender = DE_table_sender %>% as_tibble() %>% 
    dplyr::select(-p_val) %>% dplyr::select(gene, avg_log2FC)
  return(DE_table_sender)
}
```

```{r basic nicheNet analysis, eval=FALSE, include=FALSE}
Idents(rna_all) <- rna_all$original_celltype

nichenet_output <- nichenet_seuratobj_aggregate(
  seurat_obj = rna_all, 
  sender = c("T (5)","T (6)","T (9)","M (1)","M (2)","M (10)","NB (8)"), 
  receiver = c("T (5)","T (6)","T (9)","M (1)","M (2)","M (10)","NB (8)"), 
  condition_colname = "case_control",
  condition_oi = "NB",
  condition_reference = "CTRL",
  expression_pct = 0.05,
  ligand_target_matrix = ligand_target_matrix,
  lr_network = lr_network,
  weighted_networks = weighted_networks
  )

saveRDS(nichenet_output, file = "/home/out/MapMet/Rds/NicheNet_NBvsCTRL_output.Rds")
```

```{r nichenet figures, eval=FALSE, include=FALSE}
# Ligand activity analysis results
nichenet_output$ligand_activities
nichenet_output$ligand_expression_dotplot

nichenet_output$ligand_differential_expression_heatmap
nichenet_output$ligand_target_heatmap

# Inferred active ligand-target links
nichenet_output$ligand_target_heatmap
nichenet_output$ligand_target_heatmap +
  scale_fill_gradient2(low = "whitesmoke",high = "royalblue") +
  xlab("NB (all) vs. CTRL") + ylab("Prioritized ligands") # Here we get tumor specific CCC

DotPlot(rna_all, features = nichenet_output$top_targets[1:50] %>%
          rev(), split.by = "case_control", cols = "RdYlBu") + coord_flip()

DotPlot(rna_all, features = nichenet_output$top_receptors %>% rev(), 
        split.by = "case_control", cols = "RdYlBu") + coord_flip()
```

```{r advanced nicheNet analysis + figures, eval=FALSE, include=FALSE}
rna_all

table(rna_all$case_control)

# Here we need the control cells for the analysis to remove background CCC
Idents(rna_all) <- rna_all$original_celltype

celltypes <- c("T (5)","T (6)","T (9)","M (1)","M (2)","M (10)","NB (8)")

# 1. Define a set of potential ligands for both the sender-agnostic and sender-focused approach
receiver = c("T (5)","T (6)","T (9)","M (1)","M (2)","M (10)","NB (8)")
expressed_genes_receiver <- get_expressed_genes(receiver, rna_all, pct = 0.05)
# pct = 0.05: Min. 5% of the cells should express the L/R

all_receptors <- unique(lr_network$to)  
expressed_receptors <- intersect(all_receptors, expressed_genes_receiver)

potential_ligands <- lr_network %>% filter(to %in% expressed_receptors) %>% pull(from) %>% unique()

sender_celltypes <- c("T (5)","T (6)","T (9)","M (1)","M (2)","M (10)","NB (8)")

# Use lapply to get the expressed genes of every sender cell type separately here
list_expressed_genes_sender <- sender_celltypes %>% unique() %>% 
  lapply(get_expressed_genes, rna_all, 0.05)
expressed_genes_sender <- list_expressed_genes_sender %>% unlist() %>% unique()

potential_ligands_focused <- intersect(potential_ligands, expressed_genes_sender) 

# Sanity check
length(expressed_genes_sender)
length(potential_ligands)
length(potential_ligands_focused)

# 2. Define the gene set of interest
condition_oi <-  "NB"
condition_reference <- "CTRL"

rna_all_receiver <- subset(rna_all, idents = receiver)

DE_table_receiver <-  FindMarkers(object = rna_all_receiver,
                                  ident.1 = condition_oi, 
                                  ident.2 = condition_reference,
                                  group.by = "case_control",
                                  min.pct = 0.05) %>% rownames_to_column("gene")

geneset_oi <- DE_table_receiver %>% filter(p_val_adj <= 0.05 & abs(avg_log2FC) >= 0.25) %>% pull(gene)
geneset_oi <- geneset_oi %>% .[. %in% rownames(ligand_target_matrix)]

# 3. Define the background genes
background_expressed_genes <- expressed_genes_receiver %>% .[. %in% rownames(ligand_target_matrix)]

length(background_expressed_genes)
length(geneset_oi)

# 4. Perform NicheNet ligand activity analysis
ligand_activities <- predict_ligand_activities(geneset = geneset_oi,
                                               background_expressed_genes = background_expressed_genes,
                                               ligand_target_matrix = ligand_target_matrix,
                                               potential_ligands = potential_ligands)

ligand_activities <- ligand_activities %>% arrange(-aupr_corrected) %>% mutate(rank = rank(desc(aupr_corrected)))
ligand_activities

p_hist_lig_activity <- ggplot(ligand_activities, aes(x=aupr_corrected)) + 
  geom_histogram(color="black", fill="darkorange")  + 
  geom_vline(aes(xintercept=min(ligand_activities %>% top_n(30, aupr_corrected) %>% pull(aupr_corrected))),
             color="red", linetype="dashed", size=1) + 
  labs(x="ligand activity (PCC)", y = "# ligands") +
  theme_classic()

p_hist_lig_activity

best_upstream_ligands <- ligand_activities %>% top_n(30, aupr_corrected) %>% arrange(-aupr_corrected) %>% pull(test_ligand)

vis_ligand_aupr <- ligand_activities %>% filter(test_ligand %in% best_upstream_ligands) %>%
  column_to_rownames("test_ligand") %>% dplyr::select(aupr_corrected) %>% arrange(aupr_corrected) %>% as.matrix()

(make_heatmap_ggplot(vis_ligand_aupr,
                     "Prioritized ligands", "Ligand activity", 
                     legend_title = "AUPR", color = "darkorange") + 
    theme(axis.text.x.top = element_blank()))  

# 5. Infer target genes and receptors of top-ranked ligands
active_ligand_target_links_df <- best_upstream_ligands %>%
  lapply(get_weighted_ligand_target_links,
         geneset = geneset_oi,
         ligand_target_matrix = ligand_target_matrix,
         n = 100) %>%
  bind_rows() %>% drop_na()

nrow(active_ligand_target_links_df)
head(active_ligand_target_links_df)

active_ligand_target_links <- prepare_ligand_target_visualization(
  ligand_target_df = active_ligand_target_links_df,
  ligand_target_matrix = ligand_target_matrix,
  cutoff = 0.33) 

nrow(active_ligand_target_links)
head(active_ligand_target_links)

order_ligands <- intersect(best_upstream_ligands, colnames(active_ligand_target_links)) %>% rev()
order_targets <- active_ligand_target_links_df$target %>% unique() %>% intersect(rownames(active_ligand_target_links))

vis_ligand_target <- t(active_ligand_target_links[order_targets,order_ligands])

make_heatmap_ggplot(vis_ligand_target, "Prioritized ligands", "Predicted target genes",
                    color = "purple", legend_title = "Regulatory potential") +
  scale_fill_gradient2(low = "whitesmoke",  high = "purple")

 
ligand_receptor_links_df <- get_weighted_ligand_receptor_links(
  best_upstream_ligands, expressed_receptors,
  lr_network, weighted_networks$lr_sig) 

vis_ligand_receptor_network <- prepare_ligand_receptor_visualization(
  ligand_receptor_links_df,
  best_upstream_ligands,
  order_hclust = "both") 

(make_heatmap_ggplot(t(vis_ligand_receptor_network), 
                     y_name = "Ligands", x_name = "Receptors",  
                     color = "mediumvioletred", legend_title = "Prior interaction potential"))

# 6. Sender-focused approach
ligand_activities_all <- ligand_activities 
best_upstream_ligands_all <- best_upstream_ligands

ligand_activities <- ligand_activities %>% filter(test_ligand %in% potential_ligands_focused)
best_upstream_ligands <- ligand_activities %>% top_n(30, aupr_corrected) %>% arrange(-aupr_corrected) %>%
  pull(test_ligand) %>% unique()

ligand_aupr_matrix <- ligand_activities %>% filter(test_ligand %in% best_upstream_ligands) %>%
  column_to_rownames("test_ligand") %>% dplyr::select(aupr_corrected) %>% arrange(aupr_corrected)
vis_ligand_aupr <- as.matrix(ligand_aupr_matrix, ncol = 1) 

p_ligand_aupr <- make_heatmap_ggplot(vis_ligand_aupr,
                     "Prioritized ligands", "Ligand activity", 
                     legend_title = "AUPR", color = "darkorange") + 
    theme(axis.text.x.top = element_blank())

p_ligand_aupr

# Target gene plot
active_ligand_target_links_df <- best_upstream_ligands %>%
  lapply(get_weighted_ligand_target_links,
         geneset = geneset_oi,
         ligand_target_matrix = ligand_target_matrix,
         n = 100) %>%
  bind_rows() %>% drop_na()

active_ligand_target_links <- prepare_ligand_target_visualization(
  ligand_target_df = active_ligand_target_links_df,
  ligand_target_matrix = ligand_target_matrix,
  cutoff = 0.33) 

order_ligands <- intersect(best_upstream_ligands, colnames(active_ligand_target_links)) %>% rev()
order_targets <- active_ligand_target_links_df$target %>% unique() %>% intersect(rownames(active_ligand_target_links))

vis_ligand_target <- t(active_ligand_target_links[order_targets,order_ligands])

p_ligand_target <- make_heatmap_ggplot(vis_ligand_target, "Prioritized ligands", "Predicted target genes",
                    color = "purple", legend_title = "Regulatory potential") +
  scale_fill_gradient2(low = "whitesmoke",  high = "purple")

p_ligand_target

# Receptor plot
ligand_receptor_links_df <- get_weighted_ligand_receptor_links(
  best_upstream_ligands, expressed_receptors,
  lr_network, weighted_networks$lr_sig) 

vis_ligand_receptor_network <- prepare_ligand_receptor_visualization(
  ligand_receptor_links_df,
  best_upstream_ligands,
  order_hclust = "both") 

p_ligand_receptor <- make_heatmap_ggplot(t(vis_ligand_receptor_network), 
                     y_name = "Ligands", x_name = "Receptors",  
                     color = "mediumvioletred", legend_title = "Prior interaction potential")

p_ligand_receptor

best_upstream_ligands_all %in% rownames(rna_all) %>% table()

# Dotplot of sender-focused approach
p_dotplot <- DotPlot(rna_all, features = rev(best_upstream_ligands), cols = "RdYlBu") + coord_flip() +
  scale_y_discrete(position = "right")

p_dotplot


# Differentially expressed ligands
celltype_order <- levels(Idents(rna_all)) 
Idents(rna_all) <- rna_all$case_control

condition_oi <-  "NB"
condition_reference <- "CTRL"

DE_table_top_ligands <- lapply(
  celltype_order[celltype_order %in% sender_celltypes],
  get_lfc_celltype, 
  seurat_obj = rna_all,
  condition_colname = "case_control",
  condition_oi = "NB",
  condition_reference = "CTRL",
  celltype_col = clusters_of_interest,
  min.pct = 0.05, logfc.threshold = 0.5, # set a treshold of logFC and % of cells expressing the ligand
  features = best_upstream_ligands 
) 

DE_table_top_ligands <- DE_table_top_ligands %>%  reduce(., full_join) %>% 
  column_to_rownames("gene") 

vis_ligand_lfc <- as.matrix(DE_table_top_ligands[rev(best_upstream_ligands), ]) 

p_lfc <- make_threecolor_heatmap_ggplot(vis_ligand_lfc,
                                "Prioritized ligands", "LFC in Sender",
                                low_color = "midnightblue", mid_color = "white",
                                mid = median(vis_ligand_lfc), high_color = "red",
                                legend_title = "LFC")

p_lfc

(make_line_plot(ligand_activities = ligand_activities_all,
                potential_ligands = potential_ligands_focused) +
   theme(plot.title = element_text(size=11, hjust=0.1, margin=margin(0, 0, -5, 0))))

# 7. Summary visualizations of the NicheNet analysis
figures_without_legend <- cowplot::plot_grid(
  p_ligand_aupr + theme(legend.position = "none"),
  p_dotplot + theme(legend.position = "none",
                    axis.ticks = element_blank(),
                    axis.title.y = element_blank(),
                    axis.title.x = element_text(size = 12),
                    axis.text.y = element_text(size = 9),
                    axis.text.x = element_text(size = 9,  angle = 90, hjust = 0)) +
    ylab("Expression in Sender"),p_lfc + theme(legend.position = "none",
                axis.title.y = element_blank()),
  p_ligand_target + theme(legend.position = "none",
                          axis.title.y = element_blank()),
  align = "hv",
  nrow = 1,
  rel_widths = c(ncol(vis_ligand_aupr)+6, 
                 ncol(vis_ligand_lfc)+7, 
                 ncol(vis_ligand_lfc)+8, 
                 ncol(vis_ligand_target)))

legends <- cowplot::plot_grid(
    ggpubr::as_ggplot(ggpubr::get_legend(p_ligand_aupr)),
    ggpubr::as_ggplot(ggpubr::get_legend(p_dotplot)),
    ggpubr::as_ggplot(ggpubr::get_legend(p_lfc)),
    ggpubr::as_ggplot(ggpubr::get_legend(p_ligand_target)),
    nrow = 1,
    align = "h", rel_widths = c(1.5, 1, 1, 1))

combined_plot <-  cowplot::plot_grid(figures_without_legend, legends, rel_heights = c(10,5), nrow = 2, align = "hv")
combined_plot

# save analysis
#saveRDS()
```


## ___Differential CCC analysis with MultiNicheNet___

CCC specific to MYCN amplified or MYCN wt Neuroblastomas

MultiNicheNet comparison groups
1. non-MNA (ATRXm and sporadic) vs. MNA 
2. MNA vs. non-MNA (ATRXm and sporadic)

```{r LR database, eval=FALSE, include=FALSE}
# 0. prepare db
organism = "human"
options(timeout = 120)

if(organism == "human"){
  lr_network_all = 
    readRDS(url(
      "https:zenodo.org/record/10229222/files/lr_network_human_allInfo_30112033.rds"
      )) %>% 
    mutate(
      ligand = convert_alias_to_symbols(ligand, organism = organism), 
      receptor = convert_alias_to_symbols(receptor, organism = organism))
  lr_network_all = lr_network_all  %>% 
    mutate(ligand = make.names(ligand), receptor = make.names(receptor)) 
  lr_network = lr_network_all %>% 
    distinct(ligand, receptor)
  ligand_target_matrix = readRDS(url(
    "https:zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final.rds"
    ))
  colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% 
    convert_alias_to_symbols(organism = organism) %>% make.names()
  rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% 
    convert_alias_to_symbols(organism = organism) %>% make.names()
  lr_network = lr_network %>% filter(ligand %in% colnames(ligand_target_matrix))
  ligand_target_matrix = ligand_target_matrix[, lr_network$ligand %>% unique()]
  
} else if(organism == "mouse"){
  
  lr_network_all = readRDS(url(
    "https:zenodo.org/record/10229222/files/lr_network_mouse_allInfo_30112033.rds")) %>% 
    mutate(ligand = convert_alias_to_symbols(ligand, organism = organism), 
           receptor = convert_alias_to_symbols(receptor, organism = organism))
  
  lr_network_all = lr_network_all  %>% 
    mutate(ligand = make.names(ligand), receptor = make.names(receptor)) 
  lr_network = lr_network_all %>% 
    distinct(ligand, receptor)
  
  ligand_target_matrix = readRDS(url(
    "https:zenodo.org/record/7074291/files/ligand_target_matrix_nsga2r_final_mouse.rds"
    ))
  colnames(ligand_target_matrix) = colnames(ligand_target_matrix) %>% 
    convert_alias_to_symbols(organism = organism) %>% make.names()
  rownames(ligand_target_matrix) = rownames(ligand_target_matrix) %>% 
    convert_alias_to_symbols(organism = organism) %>% make.names()
  
  lr_network = lr_network %>% filter(ligand %in% colnames(ligand_target_matrix))
  ligand_target_matrix = ligand_target_matrix[, lr_network$ligand %>% unique()]
}

```

```{r MultiNicheNet analysis: (III+IV) vs. II, eval=FALSE, include=FALSE}
# 1. Set idents to group
Idents(rna) <- rna@meta.data$group

# 2.
sce = Seurat::as.SingleCellExperiment(rna, assay = "RNA")
head(colData(sce))

# 3.
SummarizedExperiment::colData(sce)$sample = SummarizedExperiment::colData(sce)$sample %>% make.names()
SummarizedExperiment::colData(sce)$group = SummarizedExperiment::colData(sce)$group %>% make.names()
SummarizedExperiment::colData(sce)$original_celltype = SummarizedExperiment::colData(sce)$original_celltype %>% make.names()

sample_id = "sample"
group_id = "group"
celltype_id = "original_celltype"

# 4. 
covariates = NA
batches = NA

# 5.
contrasts_oi = c("'((IV+III)/2)-II','II-((IV+III)/2)'")

# Note the format to indicate the contrasts! This formatting should be adhered to very strictly, and white spaces are not allowed! Check ?get_DE_info for explanation about how to define this well. The most important points are that: *each contrast is surrounded by single quotation marks *contrasts are separated by a comma without any white space *all contrasts together are surrounded by double quotation marks.

# 6.
contrast_tbl = tibble(contrast =  c("((IV+III)/2)-II","II-((IV+III)/2)"), 
                      group = c("(IV+III)","II"))

# 7. Define the sender and receiver cell types of interest
# all clusters
senders_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
receivers_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
sce = sce[, SummarizedExperiment::colData(sce)[,celltype_id] %in% 
            c(senders_oi, receivers_oi)
          ]

# only select conditions
conditions_keep = c("IV","III","II")
sce = sce[, SummarizedExperiment::colData(sce)[,group_id] %in% 
            conditions_keep
          ]
# 8. MultiNicheNet core analysis
# Cell-type filtering: determine which cell types are sufficiently present
min_cells = 5 # reducing the cut-off to not lose tumor cells (sporadic NB, low tumor numbers)
abundance_info = get_abundance_info(
  sce = sce, 
  sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, 
  min_cells = min_cells, 
  senders_oi = senders_oi, receivers_oi = receivers_oi, 
  batches = batches
  )

# The first plot visualizes the number of cells per celltype-sample combination, 
# and indicates which combinations are removed during the DE analysis because 
# there are less than min_cells in the celltype-sample combination.
abundance_info$abund_plot_sample
abundance_info$abund_plot_group
abundance_info$abund_plot_sample

# Actual filtering
sample_group_celltype_df = abundance_info$abundance_data %>% 
  filter(n > min_cells) %>% 
  ungroup() %>% 
  distinct(sample_id, group_id) %>% 
  cross_join(
    abundance_info$abundance_data %>% 
      ungroup() %>% 
      distinct(celltype_id)
    ) %>% 
  arrange(sample_id)

abundance_df = sample_group_celltype_df %>% left_join(
  abundance_info$abundance_data %>% ungroup())
print(abundance_df, n = 100)

abundance_df$n[is.na(abundance_df$n)] = 0
abundance_df$keep[is.na(abundance_df$keep)] = FALSE
abundance_df_summarized = abundance_df %>% 
  mutate(keep = as.logical(keep)) %>% 
  group_by(group_id, celltype_id) %>% 
  summarise(samples_present = sum((keep)))

celltypes_absent_one_condition = abundance_df_summarized %>% 
  filter(samples_present == 0) %>% pull(celltype_id) %>% unique() 
# find truly condition-specific cell types by searching for cell types 
# truely absent in at least one condition

celltypes_present_one_condition = abundance_df_summarized %>% 
  filter(samples_present >= 2) %>% pull(celltype_id) %>% unique() 
# require presence in at least 2 samples of one group so 
# it is really present in at least one condition

condition_specific_celltypes = intersect(
  celltypes_absent_one_condition, 
  celltypes_present_one_condition)

total_nr_conditions = SummarizedExperiment::colData(sce)[,group_id] %>% 
  unique() %>% length() 

absent_celltypes = abundance_df_summarized %>% 
  filter(samples_present < 2) %>% 
  group_by(celltype_id) %>% 
  count() %>% 
  filter(n == total_nr_conditions) %>% 
  pull(celltype_id)
  
print(paste0("condition-specific celltypes: ", condition_specific_celltypes))
print(paste0("absent celltypes: ",absent_celltypes))

analyse_condition_specific_celltypes = TRUE
if(analyse_condition_specific_celltypes == TRUE){
  senders_oi = senders_oi %>% setdiff(absent_celltypes)
  receivers_oi = receivers_oi %>% setdiff(absent_celltypes)
} else {
  senders_oi = senders_oi %>% 
    setdiff(union(absent_celltypes, condition_specific_celltypes))
  receivers_oi = receivers_oi %>% 
    setdiff(union(absent_celltypes, condition_specific_celltypes))
}

sce = sce[, SummarizedExperiment::colData(sce)[,celltype_id] %in% 
            c(senders_oi, receivers_oi)
          ]

# Gene filtering: determine which genes are sufficiently expressed in each present cell type
min_sample_prop = 0.25 # genes should be expressed in at least 50% of the samples in the group
fraction_cutoff = 0.05 # genes should show non-zero expression values in at least 5% of cells in a sample

frq_list = get_frac_exprs(
  sce = sce, 
  sample_id = sample_id, celltype_id =  celltype_id, group_id = group_id, 
  min_cells = min_cells, batches = batches,
  fraction_cutoff = fraction_cutoff, min_sample_prop = min_sample_prop)

# Now only keep genes that are expressed by at least one cell type:
genes_oi = frq_list$expressed_df %>% 
  filter(expressed == TRUE) %>% pull(gene) %>% unique() 
sce = sce[genes_oi, ]


# Pseudobulk expression calculation: determine and normalize per-sample pseudobulk expression levels for each expressed gene in each present cell type
abundance_expression_info = process_abundance_expression_info(
  sce = sce, 
  sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, 
  min_cells = min_cells, 
  senders_oi = senders_oi, receivers_oi = receivers_oi, 
  lr_network = lr_network, 
  batches = batches, 
  frq_list = frq_list, 
  abundance_info = abundance_info)
# Normalized pseudobulk expression values per gene/celltype/sample
abundance_expression_info$celltype_info$pb_df %>% head()
# average of these sample-level expression values per condition/group
abundance_expression_info$celltype_info$pb_df_group %>% head()
# values for  ligand-receptor interactions
abundance_expression_info$sender_receiver_info$pb_df %>% head()
abundance_expression_info$sender_receiver_info$pb_df_group %>% head()

# Differential expression (DE) analysis: determine which genes are DE
# pseudobulk analysis by EdgeR multi-condition multi-sample DE analysis 
# also called 'differential state' analysis by the developers of Muscat
DE_info = get_DE_info(
  sce = sce, 
  sample_id = sample_id, group_id = group_id, celltype_id = celltype_id, 
  batches = batches, covariates = covariates, 
  contrasts_oi = contrasts_oi, 
  min_cells = min_cells, 
  expressed_df = frq_list$expressed_df)

# DE results
DE_info$celltype_de$de_output_tidy %>% head()

# qc of p-value cut-off selection
# ditribution of p-values
DE_info$hist_pvals

empirical_pval = FALSE

if(empirical_pval == TRUE){
  DE_info_emp = get_empirical_pvals(DE_info$celltype_de$de_output_tidy)
  celltype_de = DE_info_emp$de_output_tidy_emp %>% select(-p_val, -p_adj) %>% 
    rename(p_val = p_emp, p_adj = p_adj_emp)
} else {
  celltype_de = DE_info$celltype_de$de_output_tidy
} 


# Combine DE information for ligand-senders and receptors-receivers
sender_receiver_de = combine_sender_receiver_de(
  sender_de = celltype_de,
  receiver_de = celltype_de,
  senders_oi = senders_oi,
  receivers_oi = receivers_oi,
  lr_network = lr_network
)

sender_receiver_de %>% head(20)

# Ligand activity prediction: use the DE analysis output to predict the activity 
# of ligands in receiver cell types and infer their potential target genes

hist(celltype_de$logFC)
hist(celltype_de$p_val)

logFC_threshold = 1      # set based on the histogram distribution
p_val_threshold = 0.05
p_val_adj = FALSE 

geneset_assessment = contrast_tbl$contrast %>% 
  lapply(
    process_geneset_data, 
    celltype_de, logFC_threshold, p_val_adj, p_val_threshold
  ) %>% 
  bind_rows() 
geneset_assessment

top_n_target = 250
verbose = TRUE
cores_system = 1
n.cores = min(cores_system, celltype_de$cluster_id %>% unique() %>% length()) 

ligand_activities_targets_DEgenes = suppressMessages(suppressWarnings(
  get_ligand_activities_targets_DEgenes(
    receiver_de = celltype_de,
    receivers_oi = intersect(receivers_oi, celltype_de$cluster_id %>% unique()),
    ligand_target_matrix = ligand_target_matrix,
    logFC_threshold = logFC_threshold,
    p_val_threshold = p_val_threshold,
    p_val_adj = p_val_adj,
    top_n_target = top_n_target,
    verbose = verbose, 
    n.cores = n.cores
  )
))

# output
ligand_activities_targets_DEgenes$ligand_activities

# Prioritization: rank cell-cell communication patterns through multi-criteria prioritization
# we calculated expression, differential expression and NicheNet ligand activity. In the final step, we will now combine all calculated information to rank all sender-ligand---receiver-receptor pairs according to group/condition specificity. We will use the following criteria to prioritize ligand-receptor interactions (equal weight to all 4 points):

# 1. Upregulation of the ligand in a sender cell type and/or upregulation of the 
# receptor in a receiver cell type - in the condition of interest.
# 2. Cell-type specific expression of the ligand in the sender cell type and 
# receptor in the receiver cell type in the condition of interest (to mitigate 
# the influence of upregulated but still relatively weakly expressed ligands/receptors)
# 3. Sufficiently high expression levels of ligand and receptor in many samples of the same group
# 4. High NicheNet ligand activity, to further prioritize ligand-receptor pairs based 
# on their predicted effect of the ligand-receptor interaction on the gene expression in the receiver cell type.

ligand_activity_down = TRUE # if TRUE, than prioritize ligands that 
# lead potentially to both up- and downregulation of target genes
# if FALSE, only consider ligands that up-regulate target genes
sender_receiver_tbl = sender_receiver_de %>% distinct(sender, receiver)

metadata_combined = SummarizedExperiment::colData(sce) %>% tibble::as_tibble()

if(!is.na(batches)){
  grouping_tbl = metadata_combined[,c(sample_id, group_id, batches)] %>% 
    tibble::as_tibble() %>% distinct()
  colnames(grouping_tbl) = c("sample","group",batches)
} else {
  grouping_tbl = metadata_combined[,c(sample_id, group_id)] %>% 
    tibble::as_tibble() %>% distinct()
  colnames(grouping_tbl) = c("sample","group")
}

prioritization_tables = suppressMessages(generate_prioritization_tables(
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de = sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    contrast_tbl = contrast_tbl,
    sender_receiver_tbl = sender_receiver_tbl,
    grouping_tbl = grouping_tbl,
    scenario = "regular", # all prioritization criteria will be weighted equally
    fraction_cutoff = fraction_cutoff, 
    abundance_data_receiver = abundance_expression_info$abundance_data_receiver,
    abundance_data_sender = abundance_expression_info$abundance_data_sender,
    ligand_activity_down = ligand_activity_down
  ))

prioritization_tables$group_prioritization_tbl %>% head(100)

# (optional) In multi-sample datasets, we can look whether expression of L-R
# across all samples is correlated with the expression of their by NicheNet predicted target genes
lr_target_prior_cor = lr_target_prior_cor_inference(
  receivers_oi = prioritization_tables$group_prioritization_tbl$receiver %>% unique(), 
  abundance_expression_info = abundance_expression_info, 
  celltype_de = celltype_de, 
  grouping_tbl = grouping_tbl, 
  prioritization_tables = prioritization_tables, 
  ligand_target_matrix = ligand_target_matrix, 
  logFC_threshold = logFC_threshold, 
  p_val_threshold = p_val_threshold, 
  p_val_adj = p_val_adj
  )

# Save all the output of MultiNicheNet

multinichenet_output = list(
    celltype_info = abundance_expression_info$celltype_info,
    celltype_de = celltype_de,
    sender_receiver_info = abundance_expression_info$sender_receiver_info,
    sender_receiver_de =  sender_receiver_de,
    ligand_activities_targets_DEgenes = ligand_activities_targets_DEgenes,
    prioritization_tables = prioritization_tables,
    grouping_tbl = grouping_tbl,
    lr_target_prior_cor = lr_target_prior_cor
  ) 

multinichenet_output = make_lite_output(multinichenet_output)

save = TRUE
if(save == TRUE){
  saveRDS(multinichenet_output, "/home/out/MapMet/Rds/multiNicheNet_II-vs-III+IV.Rds")
}
```

```{r MultiNicheNet figures I, eval=FALSE, include=FALSE}
multinichenet_output <- readRDS("/home/out/MapMet/Rds/multiNicheNet_II-vs-III+IV.Rds")

# non-MNA patient group 
group_oi = "(IV+III)/2" 

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi # Samples that were left out of the DE analysis are indicated with a smaller dot (this helps to indicate the samples that did not contribute to the calculation of the logFC, and thus not contributed to the final prioritization)

# MNA

group_oi = "II"

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi


# Filtering of target genes based on LR-target expression correlation
lr_target_prior_cor_filtered = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl$group %>% unique() %>% 
  lapply(function(group_oi){
    lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>%
      inner_join(
        multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>%
          distinct(ligand, target, direction_regulation, contrast)
        ) %>% 
      inner_join(contrast_tbl) %>% filter(group == group_oi)
    
    lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "up") %>% 
      filter( (rank_of_target < top_n_target) & (pearson > 0.5))
    
    lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "down") %>% 
      filter( (rank_of_target < top_n_target) & (pearson < -0.5))
    lr_target_prior_cor_filtered = bind_rows(
      lr_target_prior_cor_filtered_up, 
      lr_target_prior_cor_filtered_down
      )
}) %>% bind_rows()

lr_target_df = lr_target_prior_cor_filtered %>% 
  distinct(group, sender, receiver, ligand, receptor, id, target, direction_regulation) 

# RNA_COLOR_CODE_v3
colors_sender["NB..8."] = "#e31a1c"
colors_sender["T..5."] = "#1f78b4"
colors_sender["T..6."] = "#66a8de"
colors_sender["T..9."] = "#39BEB1"
colors_sender["M..1."] = "darkorange3"
colors_sender["M..2."] = "#ff7f00"
colors_sender["M..10."] = "#df912c"

# increase the top CCC
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 300, 
  rank_per_group = FALSE
  )

network = infer_intercellular_regulatory_network(lr_target_df, prioritized_tbl_oi_all)
network$links %>% head()

network_graph = visualize_network(network, colors_sender)

network_graph$plot

network$prioritized_lr_interactions
prioritized_tbl_oi_network = prioritized_tbl_oi_all %>% inner_join(
  network$prioritized_lr_interactions)
prioritized_tbl_oi_network

group_oi = "nMNA"
prioritized_tbl_oi_M = prioritized_tbl_oi_network %>% filter(group == group_oi)

plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M %>% inner_join(lr_network_all)
  )
plot_oi

# Visualize sender-agnostic ligand activities for each receiver-group combination
group_oi = "nMNA"
receiver_oi = "T..9."
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  10, 
  groups_oi = group_oi, 
  receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot

# L-R pairs of interest violin plots
ligand_oi = "HMGB1"     
receptor_oi = "CXCR4"
group_oi = "nMNA"
sender_oi = "NB..8."
receiver_oi = "M..10."

ligand_oi = "TIMP1"     
receptor_oi = "CD36"
group_oi = "nMNA"
sender_oi = "M..10."
receiver_oi = "NB..8."

p_violin = make_ligand_receptor_violin_plot(
  sce = sce, 
  ligand_oi = ligand_oi,
  receptor_oi = receptor_oi, 
  group_oi = group_oi, 
  group_id = group_id, 
  sender_oi = sender_oi, 
  receiver_oi = receiver_oi, 
  sample_id = sample_id, 
  celltype_id = celltype_id)
p_violin

# Visualize top DE genes for a cell type of interest
group_oi = "nMNA" 
receiver_oi = "T..9."
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 2 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()

p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE genes (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE genes (single-cell expression)")

# the same but only for Ligands 
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$ligand)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE ligands (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")

# the same but for Receptors
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$receptor)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE receptors (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")
```

```{r MultiNicheNet analysis: MYCN wt vs. MYCN amplified, eval=FALSE, include=TRUE}
# 1. Change to the new group identitites
Idents(rna) <- rna@meta.data$new_groups

# 2.
sce = Seurat::as.SingleCellExperiment(rna, assay = "RNA")

# 3. Define which columns in the metadata contain the neccessary information
SummarizedExperiment::colData(sce)$sample = SummarizedExperiment::colData(sce)$sample %>% make.names()
SummarizedExperiment::colData(sce)$group = SummarizedExperiment::colData(sce)$new_groups %>% make.names()
SummarizedExperiment::colData(sce)$original_celltype = SummarizedExperiment::colData(sce)$original_celltype %>% make.names()

sample_id = "sample"
group_id = "new_groups"
celltype_id = "original_celltype"

# 4. Set covariates and batches
covariates = NA
batches = NA
 
# 5. Set comparison groups
contrasts_oi = c("'nMNA-MNA','MNA-nMNA'")

# Note the format to indicate the contrasts! This formatting should be adhered to very strictly, and white spaces are not allowed! Check ?get_DE_info for explanation about how to define this well. The most important points are that: *each contrast is surrounded by single quotation marks *contrasts are separated by a comma without any white space *all contrasts together are surrounded by double quotation marks.

contrast_tbl = tibble(contrast =  c("nMNA-MNA","MNA-nMNA"), 
                      group = c("nMNA","MNA"))

# 6. Define the sender and receiver cell types of interest
# In our case all clusters
senders_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
receivers_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
sce = sce[, SummarizedExperiment::colData(sce)[,celltype_id] %in% 
            c(senders_oi, receivers_oi)]

# 6. Define which conditions to use for the analysis
conditions_keep = c("nMNA","MNA") # in this case we keep all samples
sce = sce[, SummarizedExperiment::colData(sce)[,group_id] %in% 
            conditions_keep]

# 7. MultiNicheNet analysis

# parameters
min_cells = 10
min_sample_prop = 0.50 # genes should be expressed in at least 50% of the samples in the group
fraction_cutoff = 0.05 # genes should show non-zero expression values in at least 5% of cells in a sample
empirical_pval = FALSE
logFC_threshold = 0.50      # set based on the histogram distribution
p_val_threshold = 0.05
p_val_adj = FALSE 
top_n_target = 250
verbose = TRUE
n.cores = 1
scenario = "no_frac_LR_expr" # Lower the weight of how many samples sufficiently express ligand/receptor pairs
# for equal weights use "regular"
ligand_activity_down = TRUE 
save = TRUE

# core analysis
multinichenet_output = multi_nichenet_analysis(
  sce = sce, 
  celltype_id = celltype_id, sample_id = sample_id, group_id = group_id, 
  batches = batches, covariates = covariates, 
  lr_network = lr_network, ligand_target_matrix = ligand_target_matrix, 
  contrasts_oi = contrasts_oi, contrast_tbl = contrast_tbl, 
  senders_oi = senders_oi, receivers_oi = receivers_oi,
  min_cells = min_cells, 
  fraction_cutoff = fraction_cutoff, 
  min_sample_prop = min_sample_prop,
  scenario = scenario, 
  ligand_activity_down = ligand_activity_down,
  logFC_threshold = logFC_threshold, 
  p_val_threshold = p_val_threshold, 
  p_val_adj = p_val_adj, 
  empirical_pval = empirical_pval, 
  top_n_target = top_n_target, 
  n.cores = n.cores, 
  verbose = TRUE
  )

if(save == TRUE){
  saveRDS(multinichenet_output, "/home/out/MapMetRds/multiNicheNet_nMNA-vs-MNA.Rds")
}
```

```{r MultiNicheNet figures II}

multinichenet_output <- readRDS("/home/out/MapMet/Rds/multiNicheNet_nMNA-vs-MNA.Rds")

# Visualization of differential cell-cell interactions
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  rank_per_group = FALSE
  )

prioritized_tbl_oi = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% 
  left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()

colors_sender = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)
colors_receiver = RColorBrewer::brewer.pal(n = length(senders_receivers), name = 'Spectral') %>% magrittr::set_names(senders_receivers)

circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)

# R-L expression
# MNA patient group 
group_oi = "nMNA" 

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi_nMNA = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi_nMNA # Samples that were left out of the DE analysis are indicated with a smaller dot (this helps to indicate the samples that did not contribute to the calculation of the logFC, and thus not contributed to the final prioritization)

# save plots
pdf("/home/out/MapMet/figures/multiNicheNet_nMNA_top50.pdf",
    height = 12, width = 14,pointsize = 1)
plot_oi_nMNA
dev.off()

png("/home/out/MapMet/Figures/multiNicheNet_nMNA_top50.png",
   height = 1700, width = 2000, units = "px", pointsize = 1, res = 150)
plot_oi_nMNA 
dev.off()

tiff("/home/out/MapMet/Figures/multiNicheNet_nMNA_top50.tiff",
    height = 1700, width = 2000, units = "px", res = 150, pointsize = 1)
plot_oi_nMNA 
dev.off() 

# non-MNA patient group 
group_oi = "MNA"

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi_MNA = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi_MNA

# save plots
pdf("/home/out/MapMet/figures/multiNicheNet_MNA_top50.pdf",
    height = 12,width = 14,pointsize = 1)
plot_oi_MNA
dev.off()

png( "/home/out/MapMet/Figures/multiNicheNet_MNA_top50.png",
   height = 1700, width = 2000, units = "px", pointsize = 1, res = 150)
plot_oi_MNA 
dev.off()

tiff( "/home/out/MapMet/Figures/multiNicheNet_MNA_top50.tiff",
    height = 88,width = 97, units = "mm", res = 150, pointsize = 1)
plot_oi_MNA 
dev.off() 


# Filtering of target genes based on LR-target expression correlation
lr_target_prior_cor_filtered = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl$group %>% unique() %>% 
  lapply(function(group_oi){
    lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>%
      inner_join(
        multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>%
          distinct(ligand, target, direction_regulation, contrast)
        ) %>% 
      inner_join(contrast_tbl) %>% filter(group == group_oi)
    
    lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "up") %>% 
      filter( (rank_of_target < top_n_target) & (pearson > 0.5))
    
    lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "down") %>% 
      filter( (rank_of_target < top_n_target) & (pearson < -0.5))
    lr_target_prior_cor_filtered = bind_rows(
      lr_target_prior_cor_filtered_up, 
      lr_target_prior_cor_filtered_down
      )
}) %>% bind_rows()

lr_target_df = lr_target_prior_cor_filtered %>% 
  distinct(group, sender, receiver, ligand, receptor, id, target, direction_regulation) 

# RNA_COLOR_CODE_v3
colors_sender["NB..8."] = "palegreen4"
colors_sender["T..5."] = "#cc0000"
colors_sender["T..6."] = "darkred"
colors_sender["T..9."] = "#f44336"
colors_sender["M..1."] = "#1f78b4"
colors_sender["M..2."] = "#66a8de"
colors_sender["M..10."] = "#39BEB1"


# increase the top CCC
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 300, 
  rank_per_group = FALSE
  )

network = infer_intercellular_regulatory_network(lr_target_df, prioritized_tbl_oi_all)
network$links %>% head()

network_graph = visualize_network(network, colors_sender)

final_network <- network_graph$plot
final_network

pdf("/home/out/MapMet/figures/multiNicheNet_networkGraph_v2.pdf",
    height = 5, width = 10)
final_network
dev.off()

tiff("/home/out/MapMet/figures/multiNicheNet_networkGraph.tiff",
     width = 246.5119, height = 265.9449,units = "in", res = 100)
final_network
dev.off()



network$prioritized_lr_interactions
prioritized_tbl_oi_network = prioritized_tbl_oi_all %>% inner_join(
  network$prioritized_lr_interactions)
prioritized_tbl_oi_network

group_oi = "nMNA"
prioritized_tbl_oi_M = prioritized_tbl_oi_network %>% filter(group == group_oi)

plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M %>% inner_join(lr_network_all)
  )
plot_oi

# Visualize sender-agnostic ligand activities for each receiver-group combination
group_oi = "nMNA"
receiver_oi = "T..9."
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  10, 
  groups_oi = group_oi, 
  receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot

# L-R pairs of interest violin plots
ligand_oi = "HMGB1"     
receptor_oi = "CXCR4"
group_oi = "nMNA"
sender_oi = "NB..8."
receiver_oi = "M..10."

ligand_oi = "TIMP1"     
receptor_oi = "CD36"
group_oi = "nMNA"
sender_oi = "M..10."
receiver_oi = "NB..8."

p_violin = make_ligand_receptor_violin_plot(
  sce = sce, 
  ligand_oi = ligand_oi,
  receptor_oi = receptor_oi, 
  group_oi = group_oi, 
  group_id = group_id, 
  sender_oi = sender_oi, 
  receiver_oi = receiver_oi, 
  sample_id = sample_id, 
  celltype_id = celltype_id)
p_violin

# Visualize top DE genes for a cell type of interest
group_oi = "nMNA" 
receiver_oi = "T..9."
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 2 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()

p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE genes (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE genes (single-cell expression)")

# the same but only for Ligands 
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$ligand)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE ligands (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")

# the same but for Receptors
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$receptor)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE receptors (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")
```


# ___Figure 5, J: CCC analysis, NB vs. CTRL___

# ___Figure S5, A-C: CCC analysis, NB cs. CTRL___

3. NB (all samples) vs. CTRL (non-DTCs infiltrated BM)

```{r MultiNicheNet analysis: NB vs. CTRL, eval=FALSE, include=TRUE}
# 1. Change to the new group identitites
Idents(rna_all) <- rna_all@meta.data$case_control

# 2. Seurat to single cells experiment format
sce = Seurat::as.SingleCellExperiment(rna_all, assay = "RNA")

# 3. Define which columns in the metadata contain the necessary information
SummarizedExperiment::colData(sce)$sample = SummarizedExperiment::colData(sce)$sample %>% make.names()
SummarizedExperiment::colData(sce)$group = SummarizedExperiment::colData(sce)$case_control %>% make.names()
SummarizedExperiment::colData(sce)$original_celltype = SummarizedExperiment::colData(sce)$original_celltype %>% make.names()

sample_id = "sample"
group_id = "case_control"
celltype_id = "original_celltype"

# 4. Set covariates and batches
covariates = NA # does it make sense to set here the genetic groups as covariats?
batches = NA
 
# 5. Set comparison groups
contrasts_oi = c("'NB-CTRL','CTRL-NB'")

# Note the format to indicate the contrasts! This formatting should be adhered to very strictly, and white spaces are not allowed! Check ?get_DE_info for explanation about how to define this well. The most important points are that: *each contrast is surrounded by single quotation marks *contrasts are separated by a comma without any white space *all contrasts together are surrounded by double quotation marks.

contrast_tbl = tibble(contrast =  c("NB-CTRL","CTRL-NB"), 
                      group = c("NB","CTRL"))

# 6. Define the sender and receiver cell types of interest
# In our case all clusters
senders_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
receivers_oi = SummarizedExperiment::colData(sce)[,celltype_id] %>% unique()
sce = sce[, SummarizedExperiment::colData(sce)[,celltype_id] %in% 
            c(senders_oi, receivers_oi)]

# 6. Define which conditions to use for the analysis
conditions_keep = c("NB","CTRL") # in this case we keep all samples
sce = sce[, SummarizedExperiment::colData(sce)[,group_id] %in% 
            conditions_keep]

# 7. MultiNicheNet analysis

# parameters
min_cells = 50
min_sample_prop = 0.50 # genes should be expressed in at least 50% of the samples in the group
fraction_cutoff = 0.10 # genes should show non-zero expression values in at least 5% of cells in a sample
empirical_pval = FALSE
logFC_threshold = 0.5   
p_val_threshold = 0.05
p_val_adj = FALSE 
top_n_target = 250
verbose = TRUE
n.cores = 1
scenario = "regular" 
ligand_activity_down = TRUE 
analyse_condition_specific_celltypes = TRUE
save = TRUE

# core analysis
multinichenet_output = multi_nichenet_analysis(
  sce = sce, 
  celltype_id = celltype_id, sample_id = sample_id, group_id = group_id, 
  batches = batches, covariates = covariates, 
  lr_network = lr_network, ligand_target_matrix = ligand_target_matrix, 
  contrasts_oi = contrasts_oi, contrast_tbl = contrast_tbl, 
  senders_oi = senders_oi, receivers_oi = receivers_oi,
  min_cells = min_cells, 
  fraction_cutoff = fraction_cutoff, 
  min_sample_prop = min_sample_prop,
  scenario = scenario, 
  ligand_activity_down = ligand_activity_down,
  logFC_threshold = logFC_threshold, 
  p_val_threshold = p_val_threshold, 
  p_val_adj = p_val_adj, 
  empirical_pval = empirical_pval, 
  top_n_target = top_n_target, 
  n.cores = n.cores, 
  verbose = TRUE
  )

if(save == TRUE){
  saveRDS(multinichenet_output, "/home/out/MapMet/Rds/multiNicheNet_NB-vs-CTRL.Rds")
}
```

```{r MultiNicheNet figures III}
multinichenet_output <- readRDS("/home/out/MapMet/Rds/multiNicheNet_NB-vs-CTRL.Rds")

# set color code
# RNA_COLOR_CODE_v3
colors_sender["NB..8."] = "palegreen4"
colors_sender["T..5."] = "#cc0000"
colors_sender["T..6."] = "darkred"
colors_sender["T..9."] = "#f44336"
colors_sender["M..1."] = "#1f78b4"
colors_sender["M..2."] = "#66a8de"
colors_sender["M..10."] = "#39BEB1"

colors_receiver["NB..8."] = "palegreen4"
colors_receiver["T..5."] = "#cc0000"
colors_receiver["T..6."] = "darkred"
colors_receiver["T..9."] = "#f44336"
colors_receiver["M..1."] = "#1f78b4"
colors_receiver["M..2."] = "#66a8de"
colors_receiver["M..10."] = "#39BEB1"


# Visualization of differential cell-cell interactions
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  rank_per_group = FALSE
  )

prioritized_tbl_oi = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl %>%
  filter(id %in% prioritized_tbl_oi_all$id) %>%
  distinct(id, sender, receiver, ligand, receptor, group) %>% 
  left_join(prioritized_tbl_oi_all)
prioritized_tbl_oi$prioritization_score[is.na(prioritized_tbl_oi$prioritization_score)] = 0

senders_receivers = union(prioritized_tbl_oi$sender %>% unique(), prioritized_tbl_oi$receiver %>% unique()) %>% sort()


circos_list = make_circos_group_comparison(prioritized_tbl_oi, colors_sender, colors_receiver)

pdf("/home/out/MapMet/figures/multiNicheNet_NB_circos_plot.pdf",
    height = 5, width = 5,pointsize = 1)
circos_list$NB
dev.off()

png("/home/out/MapMet/figures/multiNicheNet_NB_circos_plot.png")
circos_list$NB
dev.off()


pdf("/home/out/MapMet/figures/multiNicheNet_CTRL_circos_plot.pdf",
    height = 5, width = 5,pointsize = 1)
circos_list$CTRL
dev.off()

png("/home/out/MapMet/figures/multiNicheNet_CTRL_circos_plot.png")
circos_list$CTRL
dev.off()


# R-L expression
# NB patient group 
group_oi = "NB" 

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi_NB = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi_NB # Samples that were left out of the DE analysis are indicated with a smaller dot (this helps to indicate the samples that did not contribute to the calculation of the logFC, and thus not contributed to the final prioritization)

# save plots
pdf("/home/out/MapMet/figures/multiNicheNet_NB_top50.pdf",
    height = 12, width = 14,pointsize = 1)
plot_oi_NB
dev.off()

png("/home/out/MapMet/Figures/multiNicheNet_NB_top50.png",
   height = 1700, width = 2000, units = "px", pointsize = 1, res = 150)
plot_oi_NB 
dev.off()

tiff("/home/out/MapMet/Figures/multiNicheNet_NB_top50.tiff",
    height = 1700, width = 2000, units = "px", res = 150, pointsize = 1)
plot_oi_NB 
dev.off() 

# non-CTRL patient group 
group_oi = "CTRL"

prioritized_tbl_oi_M_50 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 50, 
  groups_oi = group_oi)

plot_oi_CTRL = make_sample_lr_prod_activity_plots(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M_50)

plot_oi_CTRL

# save plots
pdf("/home/out/MapMet/figures/multiNicheNet_CTRL_top50.pdf",
    height = 12,width = 14,pointsize = 1)
plot_oi_CTRL
dev.off()

png( "/home/out/MapMet/Figures/multiNicheNet_CTRL_top50.png",
   height = 1700, width = 2000, units = "px", pointsize = 1, res = 150)
plot_oi_CTRL 
dev.off()

tiff( "/home/out/MapMet/Figures/multiNicheNet_CTRL_top50.tiff",
    height = 1700,width = 2000, units = "px", res = 150, pointsize = 1)
plot_oi_CTRL 
dev.off() 


# Filtering of target genes based on LR-target expression correlation
lr_target_prior_cor_filtered = 
  multinichenet_output$prioritization_tables$group_prioritization_tbl$group %>% unique() %>% 
  lapply(function(group_oi){
    lr_target_prior_cor_filtered = multinichenet_output$lr_target_prior_cor %>%
      inner_join(
        multinichenet_output$ligand_activities_targets_DEgenes$ligand_activities %>%
          distinct(ligand, target, direction_regulation, contrast)
        ) %>% 
      inner_join(contrast_tbl) %>% filter(group == group_oi)
    
    lr_target_prior_cor_filtered_up = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "up") %>% 
      filter( (rank_of_target < top_n_target) & (pearson > 0.5))
    
    lr_target_prior_cor_filtered_down = lr_target_prior_cor_filtered %>% 
      filter(direction_regulation == "down") %>% 
      filter( (rank_of_target < top_n_target) & (pearson < -0.5))
    lr_target_prior_cor_filtered = bind_rows(
      lr_target_prior_cor_filtered_up, 
      lr_target_prior_cor_filtered_down
      )
}) %>% bind_rows()

lr_target_df = lr_target_prior_cor_filtered %>% 
  distinct(group, sender, receiver, ligand, receptor, id, target, direction_regulation) 

# increase the top CCC
prioritized_tbl_oi_all = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  top_n = 150, 
  rank_per_group = FALSE
  )

network = infer_intercellular_regulatory_network(lr_target_df, prioritized_tbl_oi_all)
network$links %>% head()

network_graph = visualize_network(network, colors_sender)

final_network <- network_graph$plot
final_network

pdf("/home/out/MapMet/figures/multiNicheNet_networkGraph_NBvsCTRL.pdf",
    height = 8, width = 12)
final_network
dev.off()

tiff("/home/out/MapMet/figures/multiNicheNet_networkGraph_NBvsCTRL.tiff",
     height = 1000,width = 2000, units = "px", res = 150, pointsize = 1)
final_network
dev.off()



network$prioritized_lr_interactions
prioritized_tbl_oi_network = prioritized_tbl_oi_all %>% inner_join(
  network$prioritized_lr_interactions)
prioritized_tbl_oi_network

group_oi = "NB"
prioritized_tbl_oi_M = prioritized_tbl_oi_network %>% filter(group == group_oi)

plot_oi = make_sample_lr_prod_activity_plots_Omnipath(
  multinichenet_output$prioritization_tables, 
  prioritized_tbl_oi_M %>% inner_join(lr_network_all)
  )
plot_oi

# Visualize sender-agnostic ligand activities for each receiver-group combination
group_oi = "NB"
receiver_oi = "T..9."
prioritized_tbl_oi_M_10 = get_top_n_lr_pairs(
  multinichenet_output$prioritization_tables, 
  10, 
  groups_oi = group_oi, 
  receivers_oi = receiver_oi)

combined_plot = make_ligand_activity_target_plot(
  group_oi, 
  receiver_oi, 
  prioritized_tbl_oi_M_10,
  multinichenet_output$prioritization_tables, 
  multinichenet_output$ligand_activities_targets_DEgenes, contrast_tbl, 
  multinichenet_output$grouping_tbl, 
  multinichenet_output$celltype_info, 
  ligand_target_matrix, 
  plot_legend = FALSE)
combined_plot$combined_plot

# L-R pairs of interest violin plots
ligand_oi = "HMGB1"     
receptor_oi = "CXCR4"
group_oi = "NB"
sender_oi = "NB..8."
receiver_oi = "M..10."

ligand_oi = "TIMP1"     
receptor_oi = "CD36"
group_oi = "NB"
sender_oi = "M..10."
receiver_oi = "NB..8."

p_violin = make_ligand_receptor_violin_plot(
  sce = sce, 
  ligand_oi = ligand_oi,
  receptor_oi = receptor_oi, 
  group_oi = group_oi, 
  group_id = group_id, 
  sender_oi = sender_oi, 
  receiver_oi = receiver_oi, 
  sample_id = sample_id, 
  celltype_id = celltype_id)
p_violin

# Visualize top DE genes for a cell type of interest
group_oi = "NB" 
receiver_oi = "T..9."
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 2 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()

p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE genes (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE genes (single-cell expression)")

# the same but only for Ligands 
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$ligand)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE ligands (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")

# the same but for Receptors
DE_genes = multinichenet_output$ligand_activities_targets_DEgenes$de_genes_df %>% 
  inner_join(contrast_tbl) %>% 
  filter(group == group_oi) %>% 
  arrange(p_val) %>% 
  filter(
    receiver == receiver_oi & 
      logFC > 1 & 
      p_val <= 0.05 &
      contrast == contrast_tbl %>% filter(group == group_oi) %>% pull(contrast)) %>% 
  pull(gene) %>% unique()
DE_genes = DE_genes %>% intersect(lr_network$receptor)
p_target = make_DEgene_dotplot_pseudobulk(
  genes_oi = DE_genes, 
  celltype_info = multinichenet_output$celltype_info, 
  prioritization_tables = multinichenet_output$prioritization_tables, 
  celltype_oi = receiver_oi, 
  multinichenet_output$grouping_tbl)
p_target$pseudobulk_plot + ggtitle("DE receptors (pseudobulk expression)")
p_target$singlecell_plot + ggtitle("DE ligands (single-cell expression)")
```

-------------------------------------------------------------------------------

```{r eval=FALSE, include=FALSE}
save.image("/home/out/MapMet/Rds/2024-06-05_CCC_analysis.RData")
```

# ___Session Info___

```{r}
sessionInfo()
```
