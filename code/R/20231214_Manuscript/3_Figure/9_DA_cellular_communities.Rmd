---
title: "Differential abundance testing with limma-voom"
output: html_document
date: '2023-08-19'
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "120%")
```

## Load data

First, we will find paired samples. 

```{r selection-paired-sample, message=FALSE}
library(SpatialExperiment)
library(CATALYST)
library(cowplot)
library(ggplot2)
library(diffcyt)
library(flowCore)
library(readxl)
library(scater)
library(dplyr)
library(tidyr)

path <- "/mnt/Multimodal_Imaging_Daria/PIPELINE/NEWEST_RESULTS"
spe <- readRDS(file.path(path,"results/Manuscript/spe_clustered.rds"))

clusternames_ordered <- read.csv(file.path(path, "results/Manuscript/celltypes_ordered_2.csv"), sep=";", colClasses = c("order" = "character"))
codes <- setNames(paste0(clusternames_ordered$order, "_", clusternames_ordered$celltype), clusternames_ordered$celltype)
spe$celltype_ordered <- recode(spe$celltype, !!!codes)

metadata(spe)$color_vectors$col_celltype_ordered <- metadata(spe)$color_vectors$col_celltype
names(metadata(spe)$color_vectors$col_celltype_ordered) <- recode(names(metadata(spe)$color_vectors$col_celltype), !!!codes)

spe$metacluster_2 <- spe$metacluster
spe[,spe$metacluster_2%in%c("B cell", "granulocyte", "MO/DC/NK", "T cell")]$metacluster_2 <- "immune"
spe[,spe$metacluster_2!="immune"]$metacluster_2 <- "other"
```

## Subset dataset

We will first read in the previously generated `SpatialExperiment` object and transform it into a catalyst compatible object.

```{r read-data-pheno, message=FALSE}

spe$tmp <- "na"

keep_rows <- rowData(spe)$use_channel 
keep_cols <- spe$celltype != "other" & spe$tissue=="PT" & (spe$timepoint=="DE")

sce <- SingleCellExperiment(assays=list(counts=assay(spe, "counts")[keep_rows, keep_cols], exprs=assay(spe, "counts")[keep_rows, keep_cols]))

sce$control <- factor(spe[keep_rows, keep_cols]$control)
sce$cluster_id <- factor(spe[keep_rows, keep_cols]$celltype_ordered)
sce$patient <- factor(spe[keep_rows, keep_cols]$study_id)
sce$tissue <- factor(spe[keep_rows, keep_cols]$tissue)
sce$metacluster <- factor(spe[keep_rows, keep_cols]$metacluster)
sce$tmp <- factor(spe[keep_rows, keep_cols]$tmp)

sce$mna <- factor(spe[keep_rows, keep_cols]$MYCN_amp)
mna <- as.vector(sce$mna)
mna <- replace(x = mna, list =  mna %in% c(1), values =  'MNA')
mna <- replace(x = mna, list =  mna %in% c(3), values =  'het')
mna <- replace(x = mna, list =  mna %in% c(0), values =  'nMNA')
mna <- replace(x = mna, list =  mna %in% c(9), values =  'unknown')
sce$mna <- as.factor(mna)

sce$progress <- factor(spe[keep_rows, keep_cols]$progression)
progress <- as.vector(sce$progress)
progress <- replace(x = progress, list =  progress==0, values =  'NoProg')
progress <- replace(x = progress, list =  progress==1, values =  'Prog')
sce$progress <- as.factor(progress)

sce$timepoint <- spe[keep_rows, keep_cols]$timepoint
sce$timepoint <- factor(sce$timepoint)

sce$condition <- sce$tmp 

# Add celltype information to metadata
metadata(sce)$cluster_codes <- data.frame(celltype = factor(spe[keep_rows, keep_cols]$celltype_ordered))

sce$sample_id <- factor(paste0(sce$progress, "_", sce$mna, "_", spe[keep_rows, keep_cols]$study_id, "_", spe[keep_rows, keep_cols]$fm_id, "_", sce$tissue))

```

## Plot overview of cohort

Differential analysis of cell population abundance compares the proportions of cell types across experimental conditions and aims to highlight populations that are present at different ratios. First, we calculate two tables: one that contains cell counts for each sample and population and one with the corresponding  proportions of cell types by sample.  The proportions are used only for plotting, since the statistical modeling takes the cell counts by cluster and sample as input.

For each sample, we plot its PBMC cell type composition represented with colored bars, where the size of a given stripe reflects the proportion of the corresponding cell type in a given sample (Figure \@ref(fig:diff-freqs-plot-props-barplot)).

```{r diff-freqs-plot-props-barplot, fig.cap = "Relative abundance of the 8 PBMC populations in each sample (x-axis), in the PBMC dataset, represented with a barplot. The 8 cell populations are a result of manual merging of the 20 FlowSOM metaclusters", fig.width=20, fig.height=10}

sce_tumor <- sce[,sce$metacluster=="tumor"]

set.seed(20231103)
p <- plotAbundances(sce_tumor, k = "celltype", by = "sample", col_clust=T, k_pal=metadata(spe)$color_vectors$col_celltype_ordered, 
                    linkage="ward.D", distance="manhattan") 

clustered_samples <- sapply(strsplit(levels(p$data$sample_id), "_"), function(x) paste(x[4], x[5], sep = "_"))

#Dendogram
set.seed(20231103)
wide_df <- p$data %>%
  select(-condition) %>%
  pivot_wider(names_from = cluster_id, values_from = Freq)

wide_df <- data.frame(wide_df)
rownames(wide_df) <- wide_df$sample_id
wide_df <- wide_df %>% select(-sample_id)

dist_matrix <- dist(wide_df, method = "manhattan")
hc <- hclust(dist_matrix, method = "ward.D")

#Extract clusters of cellular communities
cellular_communities <- as.data.frame(cutree(hc, k = 2)[levels(p$data$sample_id)])
colnames(cellular_communities) <- c("community_cluster")
cluster_names <- setNames(order(unique(cellular_communities$community_cluster)), c(1:max(cellular_communities$community_cluster)))
cellular_communities$community_cluster <- recode(cellular_communities$community_cluster, !!!cluster_names)

setEPS()
postscript(file.path(path, "results/Manuscript/2_Figure/R/2_Figure_dendogram_PT_DE_samples.eps"), height=12, width=30)
plot(hc)
dev.off()

setEPS()
postscript(file.path(path, "results/Manuscript/2_Figure/R/2_Figure_barplot_PT_DE_samples.eps"), height=12, width=20)
p
dev.off()
```

We now want to plot the tumor cells of the clustered microenvironments. 

```{r plot-tumor-compositions, message=FALSE, fig.width=20, fig.height=10}

sce$sample_id <- factor(paste0(spe[keep_rows, keep_cols]$fm_id, "_", spe[keep_rows, keep_cols]$tissue), levels=clustered_samples)

sce_ME <- sce[,sce$metacluster!="tumor" & sce$metacluster!="mesenchymal"]

p_ME <- plotAbundances(sce_ME, k = "celltype", by = "sample", col_clust=F, k_pal=metadata(spe)$color_vectors$col_celltype_ordered)

setEPS()
postscript(file.path(path, "results/Manuscript/2_Figure/R/2_Figure_barplot_PT_DE_ME_samples.eps"), height=12, width=20)
p_ME
dev.off()
```

As a next step, we will compute the heterogeneity of samples based on the ME and tumor cell composition.
```{r heterogeneity, message=FALSE, fig.width=7, fig.height=7}
library(BioQC)
library(hrbrthemes)

proportions <- plotAbundances(sce, k = "celltype", by = "sample")
prop <- proportions$data %>%
  select(-condition) %>%
  pivot_wider(names_from = cluster_id, values_from = Freq)

prop <- data.frame(prop)
rownames(prop) <- prop$sample_id
prop <- prop %>% select(-sample_id)

prop <- t(prop)
rownames(prop) <- levels(sce$cluster_id)
me_clusters <- unique(sce[,sce$metacluster!="tumor" & sce$metacluster!="mesenchymal"]$cluster_id)
me_prop <- prop[rownames(prop)%in%me_clusters,]
me_het <- apply(me_prop,2, entropy)
  
tumor_clusters <- unique(sce[,sce$metacluster=="tumor"]$cluster_id)
tumor_prop <- prop[rownames(prop)%in%tumor_clusters,]
tumor_het <- apply(tumor_prop,2, entropy)
```


Next, we will plot metadata on top of the clustered barplot. First, we will define the color code for the metadata. Find all built-in R color names [here](https://www.farb-tabelle.de/de/farbtabelle.htm). The [paletteer package](https://r-charts.com/color-palettes/) offers a wide range of color palettes.  

```{r define-color-code, message=FALSE}
library(ComplexHeatmap)
library(RColorBrewer)
library(paletteer)
library(bruceR)
library(circlize)
library(viridis)

meta_path <- file.path(path, '20231128_metadata_complete.csv')

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_74 = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]

meta_all = read.csv(meta_path)
meta_all <- meta_all[order(meta_all$Study_ID),] #order by study-id

exclude <- replace(x = meta_all$exclude, list =  !meta_all$exclude %in% c('no', 'maybe'), values =  'partially')

col_sample = setNames(sample(col_vector_433, length(unique(meta_all$Sample))), unique(meta_all$Sample))
col_puncture_side = setNames(brewer.pal(length(unique(meta_all$Puncture_side)), 'Set3'), unique(meta_all$Puncture_side))
col_staining_batch = setNames(viridis(length(unique(meta_all$Staining_date))), sort(unique(meta_all$Staining_date)))
col_stainer = setNames(c('#a6611a', '#dfc27d', '#80cdc1', '#018571'), unique(meta_all$Stainer))
col_imc_batch = setNames(viridis(length(unique(meta_all$IMC_date))), sort(unique(meta_all$IMC_date)))
col_imc_score = colorRamp2(c(min(meta_all$IMC_score, na.rm = TRUE), max(meta_all$IMC_score, na.rm = TRUE)/2, max(meta_all$IMC_score, na.rm = TRUE)), viridis(3)) 
col_study_id = setNames(sample(col_vector_433, length(unique(meta_all$Study_ID))), unique(meta_all$Study_ID))
col_DE_year = setNames(viridis(length(unique(meta_all$DE_date))), sort(unique(meta_all$DE_date)))
col_timepoint = setNames(c('#7fc97f', '#beaed4', '#386cb0', '#ffff99', '#386cb0'), unique(meta_all$Timepoint)) #'#fdc086'
col_aberrations = setNames(c('#a6611a','#018571','#80cdc1','#f5f5f5'), c(0,1,2,9))
col_stages = setNames(c('#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c'), unique(meta_all$stage4))
col_efs_dur = colorRamp2(c(min(meta_all$efs_dur, na.rm = TRUE), max(meta_all$efs_dur, na.rm = TRUE)/2, max(meta_all$efs_dur, na.rm = TRUE)), viridis(3))
col_tissue = setNames(c('aquamarine4','brown'), unique(meta_all$Tissue))
col_control = setNames(c('gray77', 'mediumseagreen'), unique(meta_all$control))
col_exclude = setNames(c('#018571','#a6611a','#80cdc1'), unique(exclude))
col_progress = setNames(c('gray77', 'palegreen3', 'firebrick1'), c('n.a.', 0, 1))
#col_age_diag = colorRamp2(c(min(meta_all$age_at_diag, na.rm = TRUE), max(meta_all$age_at_diag, na.rm = TRUE)/2, max(meta_all$age_at_diag, na.rm = TRUE)), viridis(3))
col_age_diag = colorRamp2(c(min(meta_all$age_at_diag, na.rm = TRUE), (quantile(meta_all$age_at_diag, 0.95, na.rm = TRUE)-min(meta_all$age_at_diag, na.rm = TRUE))/2, quantile(meta_all$age_at_diag,0.95, na.rm = TRUE)), viridis(3))
col_therapy = setNames(c('#a6611a', '#018571'), c('RAPID COJEC', 'MOD. N7'))

col_me_het = colorRamp2(c(min(me_het, na.rm = TRUE), (max(me_het, na.rm = TRUE)-min(me_het, na.rm = TRUE))/2, max(me_het, na.rm = TRUE)), viridis(3))
col_tumor_het = colorRamp2(c(min(tumor_het, na.rm = TRUE), (max(tumor_het, na.rm = TRUE)-min(tumor_het, na.rm = TRUE))/2, max(tumor_het, na.rm = TRUE)), viridis(3))
```

Now, we will plot an overview of the cohort.

```{r overview-cohort, message=FALSE, fig.height=25}

rownames(meta_all) <- paste0(meta_all$Sample, "_", meta_all$Tissue)
meta_all <- meta_all[clustered_samples,]

setEPS()
postscript(file.path(path, "results/Manuscript/2_Figure/R/PT_DE_annotation_bar.eps"), height=30, width=30)

columnAnnotation(control=meta_all$control, col=list(control=col_control)) %v%
columnAnnotation(sample=meta_all$Sample, col=list(sample=col_sample), annotation_legend_param = list(sample = list(grid_height=unit(0.05, "cm"), labels_gp = gpar(fontsize = 5)))) %v%
#columnAnnotation(exclusion=exclude, col=list(exclusion=col_exclude)) %v%
columnAnnotation(imc_score=meta_all$IMC_score, col=list(imc_score=col_imc_score))  %v%
columnAnnotation(staining_batch=meta_all$Staining_date, col=list(staining_batch=col_staining_batch)) %v%
columnAnnotation(stainer=meta_all$Stainer, col=list(stainer=col_stainer)) %v%
columnAnnotation(imc_batch=meta_all$IMC_date, col=list(imc_batch=col_imc_batch)) %v%
columnAnnotation(D_year=meta_all$DE_date, col=list(D_year=col_DE_year))  %v%
columnAnnotation(study_id=meta_all$Study_ID, col=list(study_id=col_study_id))  %v%
columnAnnotation(timepoint=meta_all$Timepoint, col=list(timepoint=col_timepoint))  %v%
columnAnnotation(tissue=meta_all$Tissue, col=list(tissue=col_tissue)) %v%
columnAnnotation(stage=meta_all$stage4, col=list(stage=col_stages)) %v%
columnAnnotation(progression=meta_all$efs, col=list(progression=col_progress))  %v%
columnAnnotation(efs_dur=meta_all$efs_dur, col=list(efs_dur=col_efs_dur)) %v%

columnAnnotation(X1p_loss=meta_all$X1p_loss, col=list(X1p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X1q_gain=meta_all$X1q_gain, col=list(X1q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X1q_loss=meta_all$X1q_loss, col=list(X1q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X2p_gain=meta_all$X2p_gain, col=list(X2p_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X3p_loss=meta_all$X3p_loss, col=list(X3p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X3q_loss=meta_all$X3q_loss, col=list(X3q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X4p_loss=meta_all$X4p_loss, col=list(X4p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X6q_loss=meta_all$X6q_loss, col=list(X6q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X7q_gain=meta_all$X7q_gain, col=list(X7q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(PTPRD_del=meta_all$PTPRD_del, col=list(PTPRD_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(CDKN2AB_del=meta_all$CDKN2AB_del, col=list(CDKN2AB_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X11q_loss=meta_all$X11q_loss, col=list(X11q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X12q_gain=meta_all$X12q_gain, col=list(X12q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X14q_loss=meta_all$X14q_loss, col=list(X14q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X17p_loss=meta_all$X17p_loss, col=list(X17p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X17q_gain=meta_all$X17q_gain, col=list(X17q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X19p_loss=meta_all$X19p_loss, col=list(X19p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X19q_loss=meta_all$X19q_loss, col=list(X19q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X22q_loss=meta_all$X22q_loss, col=list(X22q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(CDKN2AB_del=meta_all$CDKN2AB_del, col=list(CDKN2AB_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X11q_loss=meta_all$X11q_loss, col=list(X11q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X12q_gain=meta_all$X12q_gain, col=list(X12q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X14q_loss=meta_all$X14q_loss, col=list(X14q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(MYCN_amp=meta_all$MYCN_amp, col=list(MYCN_amp=col_aberrations)) %v% #annotation_legend_param = list(MYCN_amp = list(title='aberration', 
                                                                                                              #labels = c('no','yes','het'))))  %v%
                                                                                                              #labels = c('no', 'yes', 'het', 'NA'))))  %v%
columnAnnotation(TERT_rear=meta_all$TERT_rear, col=list(TERT_rear=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(ATRX_del=meta_all$ATRX_del, col=list(ATRX_del=col_aberrations), show_legend=FALSE) %v% 
columnAnnotation(ALK_amp=meta_all$ALK_amp, col=list(ALK_amp=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(ALK_mut=meta_all$ALK_mut, col=list(ALK_mut=col_aberrations), show_legend=FALSE) %v%

columnAnnotation(age=meta_all$age_at_diag, col=list(age=col_age_diag)) %v%
columnAnnotation(therapy=meta_all$therapy, col=list(therapy=col_therapy)) %v%
columnAnnotation(ME_het=me_het, col=list(ME_het=col_me_het)) %v%
columnAnnotation(TUM_het=tumor_het, col=list(TUM_het=col_tumor_het))


dev.off()

#absolute cellcount
setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_annotationbar_ncells.eps")), height=30, width=30)
draw(anno_barplot(as.vector(unname(table(sce$sample_id))), add_numbers=T, height = unit(1, "cm")))
dev.off() 

setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_annotationbar_nMEcells.eps")), height=30, width=30)
draw(anno_barplot(as.vector(unname(table(sce_ME$sample_id))), add_numbers=T, height = unit(1, "cm")))
dev.off() 

#tumor cell proportion
norm_minmax <- function(x){(x- min(x)) /(max(x)-min(x))}

robust_scalar<- function(x){(x- median(x)) /(quantile(x,probs = .75)-quantile(x,probs = .25))}

clipper <- function(data, lower, upper) {
  data[data > quantile(data, probs = c(upper))] <- quantile(data, probs = c(upper))
  data[data < quantile(data, probs = c(lower))] <- quantile(data, probs = c(lower))
  clipped_data <- norm_minmax(data)
  return(clipped_data)}

immune_infiltration <- round((unname(table(sce_ME$sample_id))/unname(table(sce$sample_id)))*100,3)
immune_inf_norm <- round(clipper(immune_infiltration, 0, 0.65),3)
setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_annotationbar_immune_inf.eps")), height=30, width=30)
draw(anno_barplot(as.vector(immune_infiltration), add_numbers=T, height = unit(1, "cm")))
dev.off() 

setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_annotationbar_immune_inf_norm.eps")), height=30, width=30)
draw(anno_barplot(as.vector(immune_inf_norm), add_numbers=T, height = unit(1, "cm")))
dev.off() 
```

As a last step, we will plot summary plots (boxplots, piecharts) of continuous and discrete metavariables per derived community cluster.
```{r summary_plots-dis, message=FALSE, fig.height=40}
library(gridExtra)

rownames(cellular_communities) <- sapply(strsplit(as.vector(rownames(cellular_communities)), "_"), function(x) paste(x[length(x) - 1], x[length(x)], sep = "_"))
meta_all[rownames(cellular_communities),"community_clusters"] <- cellular_communities$community_cluster

discrete_metadata <- c("control", "Tissue", "Timepoint", "X1p_loss", "X1q_gain", "X1q_loss", "X2p_gain", "X3p_loss", "X3q_loss", "X4p_loss",
                       "X6q_loss", "X7q_gain", "PTPRD_del", "CDKN2AB_del", "X11q_loss", "X12q_gain", "X14q_loss", "X17p_loss", "X17q_gain",
                       "X19p_loss", "X19q_loss", "X22q_loss", "MYCN_amp", "TERT_rear", "ATRX_del", "ALK_amp", "ALK_mut", "efs", "therapy")

col_timepoint = setNames(c('#beaed4', '#386cb0', '#386cb0', '#ffff99'), c("DE", "RE1", "RE2", "REL")) 
#col_aberrations = setNames(c('#a6611a','#018571','#80cdc1','#f5f5f5'), c(0,1,3,9))

discrete_metadata_colors <- list(col_control, col_tissue, col_timepoint, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_aberrations, col_progress, col_therapy)

plot_list <- list()
for (d in seq_along(discrete_metadata)) {
  meta <- na.omit(meta_all[,c(discrete_metadata[d], "community_clusters")]) #filter out rows with NA values
  meta <- meta[rowSums(meta == "") == 0, ] # filter out rows with "", e.g. for timepoint in controls
  meta <- meta[rowSums(meta == 9) == 0, ] # filter out rows with "", e.g. for timepoint in controls
  #meta <- meta_all[,c(discrete_metadata[d], "community_clusters")] #%>% replace(is.na(.), "na")
  colnames(meta) <- c("dis_var", "condition")
  
  result <- meta %>%
    group_by(condition, dis_var) %>%
    summarise(Freq = n(), .groups = 'drop')
  
  result[,"dis_var"]<- as.factor(unlist(result[,"dis_var"]))
  
plot_list[[d]] <- ggplot(result, aes(x="", y=Freq, fill=dis_var, group=dis_var)) +
    geom_col(position = "fill") +
    scale_fill_manual(values = discrete_metadata_colors[[d]], name=discrete_metadata[d]) +
    coord_polar("y", start=0)  +  
    facet_grid(.~ condition) +
    theme_void()
}
setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_metadata_discrete.eps")), height=40, width=6)
do.call("grid.arrange", c(plot_list, ncol=1))
dev.off() 

```
We will then plot continuous variables in boxplots. 

```{r summary_plots-con, message=FALSE, fig.height=25, fig.width=5}
library("ggpubr")

n_overall <- as.vector(unname(table(sce$sample_id)[clustered_samples]))
n_immune <- as.vector(unname(table(sce_ME$sample_id)[clustered_samples]))
perc_immune <- round((as.vector(unname(table(sce_ME$sample_id)[clustered_samples]))/as.vector(unname(table(sce$sample_id)[clustered_samples])))*100,3)
perc_immune_norm <- round(clipper(perc_immune, 0, 0.65),3)
het_m <- as.vector(unname(me_het[clustered_samples]))
het_t <- as.vector(unname(tumor_het[clustered_samples]))

age <- meta_all$age_at_diag
age_clipped <- meta_all$age_at_diag
age_clipped[age_clipped > quantile(age_clipped, 0.95, na.rm=T) & !is.na(age_clipped)] <- quantile(age_clipped, 0.95, na.rm=T)

cont_df <- data.frame(cbind(n_overall, n_immune, perc_immune, perc_immune_norm, het_m, het_t, age, age_clipped, cellular_communities),row.names=clustered_samples)

plot_list <- list()

for (d in colnames(cont_df)[1:ncol(cont_df)-1]) {

  df <- cont_df[,c(d, "community_cluster")] 

plot_list[[d]] <- ggboxplot(df, x = "community_cluster", y = d,
                color = "community_cluster", palette=c("slategray3", "slategray"),
                add = "jitter")+ 
                stat_compare_means() +
                theme(aspect.ratio = 1.5, legend.position="none") 
}
setEPS()
postscript(file.path(path, paste0("results/Manuscript/2_Figure/R/PT_DE_metadata_continuous.eps")), height=40, width=6)
do.call("grid.arrange", c(plot_list, ncol=1))
dev.off()
```
Now, we will show the metaclusters in that same ordering. 

```{r plot-metaclusters, message=FALSE, fig.width=20, fig.height=10}

sce$cluster_id <- sce$metacluster
metadata(sce)$cluster_codes <- data.frame(celltype = factor(sce$metacluster))
p_all <- plotAbundances(sce, k = "celltype", by = "sample", col_clust=F, k_pal=metadata(spe)$color_vectors$col_metacluster)

setEPS()
postscript(file.path(path, "results/Manuscript/2_Figure/R/2_Figure_barplot_PT_DE_all_samples.eps"), height=12, width=20)
p_all
dev.off()
```

