---
title: "Integration of morphological features"
output: html_document
date: '2023-05-18'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(scuttle)
library("FactoMineR")
library("factoextra")
library(bruceR)
library(SpatialExperiment)
library(cytomapper)
```

First, we will read the SPE object and define a matrix containing only morphological features.

```{r read-data}

path <- "/mnt/Multimodal_Imaging_Daria/PIPELINE/TEMP"

spe <- readRDS(file.path(path,"data/spe_no-dil.rds"))

morph_names <- c("area",
                 "area_convex",
                 "area_filled",
                 "axis_major_length",
                 "axis_minor_length",
                 "eccentricity",
                 "equivalent_diameter_area",
                 "perimeter",
                 "solidity",
                 "assymetry",
                 #"concavity",
                 "fill",
                 "aspect_ratio-0",
                 "perimeter_ratio-0")

morph_mat <- as.matrix(t(colData(spe)[,morph_names]))
rownames(morph_mat) <- gsub('-0','',rownames(morph_mat))

#morph_mat_scaled <- t(apply(morph_mat, 1, RESCALE, to=0:1))
morph_mat_scaled <- t(scale(t(morph_mat), center=T, scale=T))

colnames(morph_mat) <- spe$sample
colnames(morph_mat_scaled) <- spe$sample

```

We will now look at the distribution of the morphological features. 

```{r histograms-separate-x-axis, message=FALSE, fig.height=10, fig.width=7}

#out_path <- file.path(path, paste0("data/morphology-based-", tissue))

plot_list <- list()

df <- as.data.frame(t(morph_mat_scaled))

for(i in 1: ncol(df)){

  feature <- colnames(df)[i]
  
  plot_list[[i]] <- ggplot(df, aes_string(feature)) +
  geom_density(adjust = 5, color="darkblue", fill="lightblue")
}

plot <- plot_grid(plotlist = plot_list, nrow=ceiling(ncol(df)/3), ncol=3) #change this to the number of morphological features
#ggsave(filename=file.path(out_path, "BM_morph_sep_ridges.tiff"), width = 7, height = 10, units = "in", device='tiff', dpi=500)
plot
```

We will now visualize the clusters in a few samples according to their morphological feature to see if the transformation makes sense.

```{r visualize-clusters-in-image, message=FALSE, fig.width=15}
library(cytomapper)
library(viridis)
library(circlize)

files <- list.files(file.path(path, "masks_temp"))

for(i in 1: length(files)){
  #sample_id <- gsub(".tif", "", files[i])

  masks <- loadImages(file.path(path, "masks_temp", files[i]), as.is = TRUE)
  
  mcols(masks) <- DataFrame(sample_id = names(masks))
  
  for (m in 1:length(morph_names)){
    
    spe$m <- morph_mat_scaled[m,]
    #col_morph <- setNames(viridis(ncol(spe)), spe$m)

  
    plotCells(masks,
              object = spe, 
              cell_id = "ObjectNumber", img_id = "sample_id",
              colour_by = "m",
              colour = list(m = viridis(1000)),
              display = "single",
              save_plot = list(filename = file.path(path, "data/zscaling", paste0(morph_names[m], '_', files[i], 'f'))),
              legend = NULL)
  }
}

```

We will now look at the distribution of the morphological features. 

```{r histograms-separate-x-axis, message=FALSE, fig.height=10, fig.width=7}

out_path <- file.path(path, paste0("data/morphology-based-", tissue))

plot_list <- list()

df <- as.data.frame(t(morph_mat_scaled))

for(i in 1: ncol(df)){

  feature <- colnames(df)[i]
  
  plot_list[[i]] <- ggplot(df, aes_string(feature)) +
  geom_density(adjust = 5, color="darkblue", fill="lightblue")
}

plot <- plot_grid(plotlist = plot_list, nrow=ceiling(ncol(df)/3), ncol=3) #change this to the number of morphological features
ggsave(filename=file.path(out_path, "BM_morph_sep_ridges.tiff"), width = 7, height = 10, units = "in", device='tiff', dpi=500)
plot
```
Next, we will generate pseudobulk data and look at the samples with the highest or lowest mean value for each morphological feature. 

```{r pseudobulk, message=FALSE}

library(Matrix)


morph_pseudobulk <- aggregate(t(morph_mat), list(colnames(morph_mat)), mean)
rownames(morph_pseudobulk) <- morph_pseudobulk$Group.1
morph_pseudobulk <- morph_pseudobulk[,colnames(morph_pseudobulk) != "Group.1"]

```

## Outlier exclusion based on clustering
We will now cluster the data.

```{r phenograph-clustering}
library(FastPG)
library(parallel)

set.seed(221228)
n_threads <- detectCores()

mat <- t(morph_mat_scaled)

out <- FastPG::fastCluster(data=mat, k=45, num_threads=n_threads)
clusters <- factor(out$communities)

saveRDS(clusters, file.path(out_path, "clusters-morph-no-dil.rds"))

spe$BM_morph_clusters <- clusters
```

Next we will look at the single cell heatmap ordered by the identified phenograph clusters for 2000 randomly selected cells. 

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(RColorBrewer)
library(paletteer)


set.seed(20230517)

n <- length(unique(clusters))
col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
col_clusters <- setNames(sample(col_vector_433, n), unique(clusters))

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
col_tissue = c("PT" = "deepskyblue", "BM" = "orange")

mat <- t(mat)

rand_cells <- sample(seq_len(ncol(mat)), 2000)

column_ha = HeatmapAnnotation(cluster = clusters[rand_cells],
                              tissue = tissue[rand_cells],
                              col=list(cluster=col_clusters, 
                                       tissue=col_tissue 
                                       ), 
                              show_legend=T)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap with phenograph clusters (no-dil mean)",
        top_annotation = column_ha, 
        cluster_columns=F,
        column_order= order(clusters[rand_cells], decreasing=F),
        show_column_dend = F,
        show_column_names=F,
        col=viridis(100)
        )
```

Cluster 61 looks like a cluster of outlier cells (n=1203).

Next, we will look at the mean marker expression per cluster. 

```{r ingle-cell-heatmap-clusters-mean, message=FALSE, fig.height=17}
library(scuttle)

set.seed(20230135)
mat <- morph_mat_scaled

mean <- aggregate(t(mat), list(clusters), mean)

mean_t <- t(mean[,2:ncol(mean)])
colnames(mean_t) <- mean[,"Group.1"]

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))

column_ha = HeatmapAnnotation(cluster = mean[,"Group.1"], 
                              ncells=anno_barplot(as.data.frame(table(clusters))[,"Freq"], height = unit(3, "cm")),
                              col=list(cluster=col_clusters 
                                       ), 
                              show_legend=T)

Heatmap(mean_t, 
        column_title = "Cluster-means heatmap with phenograph clusters (no-dil)-scaled",
        top_annotation = column_ha, 
        cluster_columns=T,
        show_column_dend = F,
        show_column_names=T,
        show_row_names=T,
        col=viridis(100)
        )


```
We will now look at cluster 38 in the images. Let's first find out which sample has the highest number of cells from cluster 38. 

```{r identify-size-outlier-samples, fig.width=20}

c <- "38"

data <- data.frame(sample=spe$sample_id, cluster = spe$BM_morph_clusters)
data$freq <- 1

data_wide <- data %>% pivot_wider(names_from = c("cluster"), values_from = "freq", values_fn = sum, values_fill = 0)
data_long <- data_wide %>% pivot_longer(cols = !sample, names_to = "cluster", values_to = "count") 

clust <- data_long[data_long$cluster==c,]
clust <- clust[order(clust$count, decreasing=T), ]
max_sample <- clust$sample[1]

print(paste("The sample with the most outlier cells is", max_sample, "."))
```
The sample with the highest number of cells from cluster 38 is 10-2679_TU. We will color the masks of that sample according to the cluster 61.

```{r color-outlier-masks, message=FALSE}

col_celltype <- setNames(c("red", "white"), c("yes", "no"))

spe$outlier <- "no"
spe[,spe$BM_morph_clusters == "38"]$outlier <- "yes"

files <- list.files(file.path(path, "masks_temp"))

for(i in 1: length(files)){
  masks <- loadImages(file.path(path, "masks_temp", files[i]), as.is = TRUE)
  
  mcols(masks) <- DataFrame(sample_id = names(masks))
  
  
  plotCells(masks,
            object = spe, 
            cell_id = "ObjectNumber", img_id = "sample_id",
            colour_by = "outlier",
            colour = list(outlier = col_celltype),
            display="single",
            save_plot = list(filename = file.path(out_path, files[i])),
            legend=NULL)
}

```

Since cluster 38 includes also a lot of real cells, we will perform data cleaning based on manual thresholding. 

## Outlier exclusion based on manual thresholding

In the distribution of morphological features, we can see that we have a lot of outliers. 

We will now identify feature-individual thresholds. 

```{r quality-control-outliers, message=FALSE}

colnames(morph_mat) <- colnames(spe)
colnames(morph_mat_scaled) <- colnames(spe)

feat <- "solidity"

morph_mat_order <- morph_mat[feat,order(morph_mat[feat,], decreasing=F)]
outlier_cell <- names(morph_mat_order[1])
position <- spatialCoords(spe[,outlier_cell])
print(paste("The outlier cell is in sample", outlier_cell, "at position x=", position[1], "and y=", position[2], "."))
```

We will add another feature to the SPE object for outlier annotation.

```{r annotate-outliers, message=FALSE}
sum(spe$area <= 150)

spe$outlier <- "no"
spe[,spe$area <= 150]$outlier <- "yes"
```

We will check which samples have the most outliers. 

```{r identify-size-outlier-samples, fig.width=20}

c <- "yes"

data <- data.frame(sample=spe$sample_id, cluster = spe$outlier)
data$freq <- 1

data_wide <- data %>% pivot_wider(names_from = c("cluster"), values_from = "freq", values_fn = sum, values_fill = 0)
data_long <- data_wide %>% pivot_longer(cols = !sample, names_to = "cluster", values_to = "count") 

clust <- data_long[data_long$cluster==c,]
clust <- clust[order(clust$count, decreasing=T), ]
max_sample <- clust$sample[1]

print(paste("The sample with the most outlier cells is", max_sample, "."))
```

We will pseudo-color the masks of outlier cells in the sample with the highest presence. 


```{r color-outlier-masks, message=FALSE}
out_path <- file.path(path, "data", paste0("morphology-based-", tissue))

col_celltype <- setNames(c("red", "white"), c("yes", "no"))

files <- list.files(file.path(path, "masks_temp"))

for(i in 1: length(files)){
  masks <- loadImages(file.path(path, "masks_temp", files[i]), as.is = TRUE)
  
  mcols(masks) <- DataFrame(sample_id = names(masks))
  
  
  plotCells(masks,
            object = spe, 
            cell_id = "ObjectNumber", img_id = "sample_id",
            colour_by = "outlier",
            colour = list(outlier = col_celltype),
            display="single",
            save_plot = list(filename = file.path(out_path, files[i])),
            legend=NULL)
}

```

Upon visualization in the images, we can confirm that the outliers are indeed outliers. Now we will exclude them. 

```{r exclude-outliers, message=FALSE}
lower <- 100
upper <- max(spe$area)+1
spe <- spe[,spe$area>lower & spe$area<upper]

#Rebuild the matrix of morphological features of the remaining cells
morph_mat <- as.matrix(t(colData(spe)[,morph_names]))
rownames(morph_mat) <- gsub('-0','',rownames(morph_mat))
morph_mat_scaled <- t(apply(morph_mat, 1, RESCALE, to=0:1))
```

We will now look at how the distribution of morphological features changed. 

```{r histograms-separate-x-axis-upon-exclusion, message=FALSE, fig.height=10, fig.width=7}


plot_list <- list()

df <- as.data.frame(t(morph_mat))

for(i in 1: ncol(df)){

  feature <- colnames(df)[i]
  
  plot_list[[i]] <- ggplot(df, aes_string(feature)) +
  geom_density(adjust = 5, color="darkblue", fill="lightblue")
}

plot <- plot_grid(plotlist = plot_list, nrow=ceiling(ncol(df)/3), ncol=3) #change this to the number of morphological features
ggsave(filename=file.path(out_path, paste0("BM_morph_scaled_sep_ridges_post-", feat, ".tiff")), width = 7, height = 10, units = "in", device='tiff', dpi=500)
plot
```



