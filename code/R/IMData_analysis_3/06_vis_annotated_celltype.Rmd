---
title: "UMAP and histograms after annotation"
output: html_document
date: '2022-12-28'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
```

In this RMD file, we will plot UMAPs and histograms on the annotated SPE.

```{r read-data}

path <- "/mnt/Multimodal_Imaging_Daria/PIPELINE/NEWEST_RESULTS"

spe <- readRDS(file.path(path,"results/in_house/spe_clustered.rds"))

```


Then we will generate a matrix of the expression data to be able to run the plots below. 

```{r generate-dataframes, message=FALSE, fig.height=7}
library(SpatialExperiment)

mat_lq <- assay(spe, "exprs")[!rowData(spe)$use_channel,]
mat_hq <- assay(spe, "exprs")[rowData(spe)$use_channel,]
mat_morph <- rbind(mat_hq, "area"=spe$area_clipped, "solidity"=spe$solidity_clipped, "aspect_ratio"=spe$aspect_ratio_clipped)
```

Then we will plot a heatmap of 2000 randomly selected cells. 

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(RColorBrewer)
library(paletteer)
set.seed(20230521)

mat <- mat_hq
celltype <- spe$celltype
tissue <- spe$tissue

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
col_tissue = c("PT" = "deepskyblue", "BM" = "orange")

rand_cells <- sample(seq_len(ncol(mat)), 2000)


area = mat_morph["area",]
solidity = mat_morph["solidity",]
aspect_ratio = mat_morph["aspect_ratio",]

clPARP = mat_lq["clPARP_Yb176_mean",]

col_area = colorRamp2(c(min(area[rand_cells]),min(area[rand_cells])+(max(area[rand_cells])-min(area[rand_cells]))/2, max(area[rand_cells])), c("blue", "white", "red"))
col_solidity = colorRamp2(c(min(solidity[rand_cells]),min(solidity[rand_cells])+(max(solidity[rand_cells])-min(solidity[rand_cells]))/2, max(solidity[rand_cells])), c("blue", "white", "red"))
col_aspect_ratio = colorRamp2(c(min(aspect_ratio[rand_cells]),min(aspect_ratio[rand_cells])+(max(aspect_ratio[rand_cells])-min(aspect_ratio[rand_cells]))/2, max(aspect_ratio[rand_cells])), c("blue", "white", "red"))

col_clPARP = colorRamp2(c(min(clPARP[rand_cells]),min(clPARP[rand_cells])+(max(clPARP[rand_cells])-min(clPARP[rand_cells]))/2, max(clPARP[rand_cells])), c("blue", "white", "red"))

column_ha = HeatmapAnnotation(celltype = celltype[rand_cells],
                              tissue = tissue[rand_cells],
                              area = area[rand_cells],
                              solidity = solidity[rand_cells],
                              aspect_ratio = aspect_ratio[rand_cells],
                              clPARP = clPARP[rand_cells],
                              col=list(celltype=metadata(spe)$color_vectors$col_celltype, 
                                       tissue=col_tissue,
                                       area = col_area,
                                       solidity = col_solidity,
                                       aspect_ratio = col_aspect_ratio,
                                       clPARP = col_clPARP
                                       ), 
                              show_legend=T)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap with 2000 randomly selected cells",
        top_annotation = column_ha, 
        cluster_columns=F,
        column_order= order(celltype[rand_cells], decreasing=F),
        show_column_dend = T,
        show_column_names=F,
        col=viridis(100)
        )
```

Now we will plot these heatmaps per cluster.

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}

set.seed(20230521)

celltype <- spe$celltype

for(i in 1: length(unique(celltype))){

  c <- unique(celltype)[i]

  mat_c <- mat_hq[,celltype==c]
  ct <- celltype[celltype==c]
  tis <- spe$tissue[celltype==c]
  
  col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
  col_tissue = c("PT" = "deepskyblue", "BM" = "orange")
  
  if (length(ct) < 8000){len=length(ct)}else{len=8000}

  rand_cells <- sample(seq_len(ncol(mat_c)), len)
  
  
  area_c = mat_morph["area",celltype==c]
  solidity_c = mat_morph["solidity",celltype==c]
  aspect_ratio_c = mat_morph["aspect_ratio",celltype==c]
  
  clPARP_c = mat_lq["clPARP_Yb176_mean",celltype==c]
  
  col_area_c = colorRamp2(c(min(area_c[rand_cells]),min(area_c[rand_cells])+(max(area_c[rand_cells])-min(area_c[rand_cells]))/2, max(area_c[rand_cells])), c("blue", "white", "red"))
  col_solidity_c = colorRamp2(c(min(solidity_c[rand_cells]),min(solidity_c[rand_cells])+(max(solidity_c[rand_cells])-min(solidity_c[rand_cells]))/2, max(solidity_c[rand_cells])), c("blue", "white", "red"))
  col_aspect_ratio_c = colorRamp2(c(min(aspect_ratio_c[rand_cells]),min(aspect_ratio_c[rand_cells])+(max(aspect_ratio_c[rand_cells])-min(aspect_ratio_c[rand_cells]))/2, max(aspect_ratio_c[rand_cells])), c("blue", "white", "red"))
  
  col_clPARP_c = colorRamp2(c(min(clPARP_c[rand_cells]),min(clPARP_c[rand_cells])+(max(clPARP_c[rand_cells])-min(clPARP_c[rand_cells]))/2, max(clPARP_c[rand_cells])), c("blue", "white", "red"))
  
  column_ha = HeatmapAnnotation(celltype = ct[rand_cells],
                                tissue = tis[rand_cells],
                                area = area_c[rand_cells],
                                solidity = solidity_c[rand_cells],
                                aspect_ratio = aspect_ratio_c[rand_cells],
                                clPARP = clPARP_c[rand_cells],
                                col=list(celltype=metadata(spe)$color_vector$col_celltype, 
                                         tissue=col_tissue,
                                         area = col_area_c,
                                         solidity = col_solidity_c,
                                         aspect_ratio = col_aspect_ratio_c,
                                         clPARP = col_clPARP_c
                                         ), 
                                show_legend=T)
  
  png(file=file.path(path, paste0("results/in_house/heatmaps/merged/clusters-tissue-sep/BM/", c , ".tiff")),width=18,height=8,units="in", res=1200)
  
  ht<- Heatmap(mat_c[,rand_cells], 
          column_title = "Single-cell heatmap with 8000 randomly selected cells",
          top_annotation = column_ha, 
          cluster_columns=F,
          column_order= order(tis[rand_cells], decreasing=F),
          show_column_dend = T,
          show_column_names=F,
          col=viridis(100)
          )
  draw(ht)
  
  dev.off()
}

```

Next we will look at the single cell heatmap ordered by the identified phenograph clusters and sample the same number of cells from BM and PT samples. 

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(RColorBrewer)
library(paletteer)

set.seed(20230618) 

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
col_tissue = c("PT" = "deepskyblue", "BM" = "orange")

#Get same number of PT and BM cells
pt_index <- which(tissue=="PT")
bm_index <- which(tissue=="BM")
rand_cells_pt <- sample(seq_len(length(pt_index)), 4000)
rand_cells_bm <- sample(seq_len(length(bm_index)), 4000)
pt_index_rand <- pt_index[rand_cells_pt]
bm_index_rand <- bm_index[rand_cells_bm]
rand_cells <- c(pt_index_rand, bm_index_rand)

col_area = colorRamp2(c(min(area[rand_cells]),min(area[rand_cells])+(max(area[rand_cells])-min(area[rand_cells]))/2, max(area[rand_cells])), c("blue", "white", "red"))
col_solidity = colorRamp2(c(min(solidity[rand_cells]),min(solidity[rand_cells])+(max(solidity[rand_cells])-min(solidity[rand_cells]))/2, max(solidity[rand_cells])), c("blue", "white", "red"))
col_aspect_ratio = colorRamp2(c(min(aspect_ratio[rand_cells]),min(aspect_ratio[rand_cells])+(max(aspect_ratio[rand_cells])-min(aspect_ratio[rand_cells]))/2, max(aspect_ratio[rand_cells])), c("blue", "white", "red"))

col_clPARP = colorRamp2(c(min(clPARP[rand_cells]),min(clPARP[rand_cells])+(max(clPARP[rand_cells])-min(clPARP[rand_cells]))/2, max(clPARP[rand_cells])), c("blue", "white", "red"))

column_ha = HeatmapAnnotation(cluster = celltype[rand_cells],
                              tissue = tissue[rand_cells],
                              area = area[rand_cells],
                              solidity = solidity[rand_cells],
                              aspect_ratio = aspect_ratio[rand_cells],
                              clPARP = clPARP[rand_cells],
                              col=list(cluster=metadata(spe)$color_vector$col_celltype, 
                                       tissue=col_tissue,
                                       area = col_area,
                                       solidity = col_solidity,
                                       aspect_ratio = col_aspect_ratio,
                                       clPARP = col_clPARP
                                       ), 
                              show_legend=T)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap showing 4000 random cells per tissue type",
        top_annotation = column_ha, 
        cluster_columns=F,
        column_order= order(celltype[rand_cells], decreasing=F),
        show_column_dend = T,
        show_column_names=F,
        col=viridis(100)
        )
```
Next we will look at the single cell heatmap ordered by the identified phenograph clusters and sample the same number of cells from BM and PT samples per cluster. 

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}

set.seed(20230517)

n <- length(unique(celltype))

count <- 45
rand_cells <- c()

#Get same number of PT and BM cells per cluster
for (i in 1: length(unique(celltype))){
  pt_index <- which(tissue=="PT" & celltype == unique(celltype)[i])
  bm_index <- which(tissue=="BM" & celltype == unique(celltype)[i])
  if (length(pt_index) < count){
    pt_diff <- count-length(pt_index)
    print(paste("PT_diff: ", pt_diff, " for cluster ", unique(celltype)[i]))
    rand_index_pt <- sample(pt_index, length(pt_index))
    rand_index_bm <- sample(bm_index, (count + pt_diff))
  } else if (length(bm_index) < count){
    bm_diff <- count-length(bm_index)
    rand_index_pt <- sample(pt_index, (count + bm_diff))
    rand_index_bm <- sample(bm_index, length(bm_index))
  } else {
      rand_index_pt <- sample(pt_index, count)
      rand_index_bm <- sample(bm_index, count)
  }

  rand_cells <- c(rand_cells, rand_index_pt, rand_index_bm)
}

col_area = colorRamp2(c(min(area[rand_cells]),min(area[rand_cells])+(max(area[rand_cells])-min(area[rand_cells]))/2, max(area[rand_cells])), c("blue", "white", "red"))
col_solidity = colorRamp2(c(min(solidity[rand_cells]),min(solidity[rand_cells])+(max(solidity[rand_cells])-min(solidity[rand_cells]))/2, max(solidity[rand_cells])), c("blue", "white", "red"))
col_aspect_ratio = colorRamp2(c(min(aspect_ratio[rand_cells]),min(aspect_ratio[rand_cells])+(max(aspect_ratio[rand_cells])-min(aspect_ratio[rand_cells]))/2, max(aspect_ratio[rand_cells])), c("blue", "white", "red"))

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
col_tissue = c("PT" = "deepskyblue", "BM" = "orange")

#mat <- t(mat)
                                       
                                       
column_ha = HeatmapAnnotation(cluster = celltype[rand_cells],
                              tissue = tissue[rand_cells],
                              area = area[rand_cells],
                              solidity = solidity[rand_cells],
                              aspect_ratio = aspect_ratio[rand_cells],
                              col=list(cluster=metadata(spe)$color_vector$col_celltype, 
                                       tissue=col_tissue,
                                       area = col_area,
                                       solidity = col_solidity,
                                       aspect_ratio = col_aspect_ratio
                                       ), 
                              show_legend=T)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap same number of cells from each tissue per cluster",
        top_annotation = column_ha, 
        cluster_columns=F,
        cluster_rows=F,
        column_order= order(celltype[rand_cells], decreasing=F),
        show_column_dend = T,
        show_column_names=F,
        col=viridis(100)
        )
```

Next we will look at the single cell heatmap ordered by the identified phenograph clusters and sample the same number of cells from each cluster

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}

set.seed(20230517)

n <- length(unique(celltype))

count <- 90
rand_cells <- c()

#Get same number of PT and BM cells per cluster
for (i in 1: length(unique(celltype))){
  idx <- which(celltype == unique(celltype)[i])
  if(length(idx)<count)
    {rand_idx <- sample(idx, length(idx))}
  else
    {rand_idx <- sample(idx, count)}
  
  rand_cells <- c(rand_cells, rand_idx)
}

col_area = colorRamp2(c(min(area[rand_cells]),min(area[rand_cells])+(max(area[rand_cells])-min(area[rand_cells]))/2, max(area[rand_cells])), c("blue", "white", "red"))
col_solidity = colorRamp2(c(min(solidity[rand_cells]),min(solidity[rand_cells])+(max(solidity[rand_cells])-min(solidity[rand_cells]))/2, max(solidity[rand_cells])), c("blue", "white", "red"))
col_aspect_ratio = colorRamp2(c(min(aspect_ratio[rand_cells]),min(aspect_ratio[rand_cells])+(max(aspect_ratio[rand_cells])-min(aspect_ratio[rand_cells]))/2, max(aspect_ratio[rand_cells])), c("blue", "white", "red"))

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))
col_tissue = c("PT" = "deepskyblue", "BM" = "orange")

#mat <- t(mat)

column_ha = HeatmapAnnotation(metacluster=spe$metacluster[rand_cells],
                              cluster = celltype[rand_cells],
                              tissue = tissue[rand_cells],
                              area = area[rand_cells],
                              solidity = solidity[rand_cells],
                              aspect_ratio = aspect_ratio[rand_cells],
                              col=list(metacluster=metadata(spe)$color_vectors$col_metacluster,
                                       cluster=metadata(spe)$color_vectors$col_celltype, 
                                       tissue=col_tissue,
                                       area = col_area,
                                       solidity = col_solidity,
                                       aspect_ratio = col_aspect_ratio
                                       ), 
                              annotation_legend_param = list(cluster = list(at = unique(celltype[rand_cells][order(as.integer(sub('_.*', '', celltype[rand_cells])), decreasing=F)]))), #delete later
                              show_legend=T)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap showing clusters of equal number of randomly selected cells",
        top_annotation = column_ha, 
        cluster_columns=F,
        cluster_rows=F,
        #column_order= order(celltype[rand_cells], decreasing=F),
        column_order = order(as.integer(sub('_.*', '', celltype[rand_cells])), decreasing=F),
        show_column_dend = T,
        show_column_names=F,
        col=viridis(100)
        )
```

Next, we will look at the mean marker expression per cluster. The next two code blocks can be also run for tissue types (PT/BM) separately. 

```{r ingle-cell-heatmap-clusters-mean, message=FALSE, fig.height=15, fig.width=18}
library(scuttle)

set.seed(20230135)

#calculate mean heatmap over all cells
matrix_hq <- mat_hq
matrix_lq <- mat_lq
morph_matrix <- mat_morph
clust <- celltype

#calculate heatmap over tissue-derived cells
# tissue <- "PT"
# matrix_hq <- mat_hq[,spe$tissue==tissue]
# matrix_lq <- mat_lq[,spe$tissue==tissue]
# morph_matrix <- mat_morph[,spe$tissue==tissue]
# clust <- celltype[spe$tissue==tissue]

mean <- aggregate(t(matrix_hq), list(clust), mean)

mean_t <- t(mean[,2:ncol(mean)])
mean_t <- t(apply(mean_t, 1, RESCALE, to=0:1))
colnames(mean_t) <- mean[,"Group.1"]

mean_morph <- aggregate(t(morph_matrix), list(clust), mean)

area_mean = mean_morph[,"area"]
solidity_mean = mean_morph[,"solidity"]
aspect_ratio_mean = mean_morph[,"aspect_ratio"]

mean_lq <- aggregate(t(matrix_lq), list(clust), mean)

clPARP_mean = mean_lq[,"clPARP_Yb176_mean"]

mean_metaclust <-aggregate(spe$metacluster, list(clust), max)
mean_metacluster <- mean_metaclust$x

col_mean_area = colorRamp2(c(min(area_mean),min(area_mean)+(max(area_mean)-min(area_mean))/2, max(area_mean)), c("blue", "white", "red"))
col_mean_solidity = colorRamp2(c(min(solidity_mean),min(solidity_mean)+(max(solidity_mean)-min(solidity_mean))/2, max(solidity_mean)), c("blue", "white", "red"))
col_mean_aspect_ratio = colorRamp2(c(min(aspect_ratio_mean),min(aspect_ratio_mean)+(max(aspect_ratio_mean)-min(aspect_ratio_mean))/2, max(aspect_ratio_mean)), c("blue", "white", "red"))
col_mean_clPARP = colorRamp2(c(min(clPARP_mean),min(clPARP_mean)+(max(clPARP_mean)-min(clPARP_mean))/2, max(clPARP_mean)), c("blue", "white", "red"))

column_ha = HeatmapAnnotation(metacluster=mean_metacluster,
                              celltype = mean[,"Group.1"], 
                              area=area_mean,
                              solidity = solidity_mean,
                              aspect_ratio = aspect_ratio_mean,
                              clPARP = clPARP_mean,
                              ncells=anno_barplot(as.data.frame(table(clust))[,"Freq"], height = unit(3, "cm")),
                              col=list(metacluster=metadata(spe)$color_vectors$col_metacluster,
                                       celltype=metadata(spe)$color_vectors$col_celltype, 
                                       area=col_mean_area,
                                       solidity=col_mean_solidity,
                                       aspect_ratio=col_mean_aspect_ratio,
                                       clPARP = col_mean_clPARP
                                       ), 
                              show_legend=T)


Heatmap(mean_t, 
        column_title = "Heatmap showing mean per cluster - unscaled",
        top_annotation = column_ha, 
        cluster_columns=T,
        clustering_distance_columns="pearson", #use euclidian, kendal or pearson
        clustering_method_columns="single",
        cluster_rows=T,
        show_column_dend = T,
        show_column_names=T,
        show_row_names=T,
        col=viridis(100)
        )


```
We can see that cluster 38 are the sticky cells, which are positive for everything. We will exclude this cluster and re-generate the heatmap.

```{r ingle-cell-heatmap-clusters-mean, message=FALSE, fig.height=20, fig.width=18}
library(scuttle)
library(bruceR)

sticky_cluster <- "other"

# Feature-wise scaling
mean_t_wo_sticky <- mean_t[,colnames(mean_t)!=sticky_cluster]
mean_t_wo_sticky <- t(apply(mean_t_wo_sticky, 1, RESCALE, to=0:1))
clusters_wo_sticky <- spe$celltype[spe$celltype!=sticky_cluster]

area_mean_wo_sticky <- area_mean[colnames(mean_t)!=sticky_cluster]
solidity_mean_wo_sticky <- solidity_mean[colnames(mean_t)!=sticky_cluster]
aspect_ratio_mean_wo_sticky <- aspect_ratio_mean[colnames(mean_t)!=sticky_cluster]
clPARP_mean_wo_sticky <- clPARP_mean[colnames(mean_t)!=sticky_cluster]


col_mean_area_wo_sticky = colorRamp2(c(min(area_mean_wo_sticky),min(area_mean_wo_sticky)+(max(area_mean_wo_sticky)-min(area_mean_wo_sticky))/2, max(area_mean_wo_sticky)), c("blue", "white", "red"))
col_mean_solidity_wo_sticky = colorRamp2(c(min(solidity_mean_wo_sticky),min(solidity_mean_wo_sticky)+(max(solidity_mean_wo_sticky)-min(solidity_mean_wo_sticky))/2, max(solidity_mean_wo_sticky)), c("blue", "white", "red"))
col_mean_aspect_ratio_wo_sticky = colorRamp2(c(min(aspect_ratio_mean_wo_sticky),min(aspect_ratio_mean_wo_sticky)+(max(aspect_ratio_mean_wo_sticky)-min(aspect_ratio_mean_wo_sticky))/2, max(aspect_ratio_mean_wo_sticky)), c("blue", "white", "red"))
col_mean_clPARP_wo_sticky = colorRamp2(c(min(clPARP_mean_wo_sticky),min(clPARP_mean_wo_sticky)+(max(clPARP_mean_wo_sticky)-min(clPARP_mean_wo_sticky))/2, max(clPARP_mean_wo_sticky)), c("blue", "white", "red"))

col_celltype <- metadata(spe)$color_vectors$col_celltype
col_clusters_wo_sticky <- col_celltype[names(col_celltype)!=sticky_cluster]

mean_metacluster_wo_sticky <- mean_metaclust[mean_metaclust$Group.1!="other",]$x

column_ha = HeatmapAnnotation(metacluster=mean_metacluster_wo_sticky,
                              celltype = colnames(mean_t_wo_sticky),
                              area=area_mean_wo_sticky,
                              solidity=solidity_mean_wo_sticky,
                              aspect_ratio=aspect_ratio_mean_wo_sticky,
                              clPARP=clPARP_mean_wo_sticky,
                              ncells=anno_barplot(as.data.frame(table(clusters_wo_sticky))[,"Freq"], height = unit(3, "cm")),
                              col=list(metacluster=metadata(spe)$color_vectors$col_metacluster, 
                                       celltype=col_clusters_wo_sticky,
                                       area=col_mean_area_wo_sticky,
                                       solidity=col_mean_solidity_wo_sticky,
                                       aspect_ratio=col_mean_aspect_ratio_wo_sticky,
                                       clPARP=col_mean_clPARP_wo_sticky
                                       ), 
                              show_legend=T)

set.seed(210220)
Heatmap(mean_t_wo_sticky, 
        column_title = "Heatmap showing mean per cluster without sticky cells - scaled",
        top_annotation = column_ha, 
        cluster_columns=T,
        clustering_distance_columns="pearson", #use euclidean, kendall or pearson
        clustering_method_columns="single", #use single or ward.D2
        cluster_rows=T,
        show_column_dend = T,
        show_column_names=T,
        show_row_names=T,
        column_dend_height = unit(10, "cm"),
        col=viridis(100)
        )



```

Next we will visualize the tissue type in the UMAP space.

```{r visualizing-umap-by-phenograph-cluster, message=F, fig.width=17}
mat_red <- reducedDim(spe, "UMAP") 
tissue <- spe$tissue
mat_red_df <- as.data.frame(mat_red)
mat_red_df["tissue"] <- tissue
mat_red_df_rand <- mat_red_df[sample(1:nrow(mat_red_df)),]
  
plot <- ggplot(mat_red_df_rand, aes(x=V1, y=V2, colour=tissue)) +
    geom_point(alpha=0.5, show.legend=T) + 
    ggtitle("Tissue type") +
    scale_colour_manual(values = col_tissue) +
    theme(plot.title = element_text(size = 15), 
          axis.title = element_text(size=15), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          legend.text = element_text(size=15))

plot
```

Next we will visualize the clusters in the UMAP space.

```{r visualizing-umap-by-phenograph-cluster, message=F, fig.width=17}

mat_red_df <- as.data.frame(mat_red)
mat_red_df["celltype"] <- celltype
mat_red_df_rand <- mat_red_df[sample(1:nrow(mat_red_df)),]
  
plot <- ggplot(mat_red_df_rand, aes(x=V1, y=V2, colour=celltype)) +
    geom_point(show.legend=T) + 
    ggtitle("Phenograph cluster") +
    scale_colour_manual(values = col_celltype) +
    theme(plot.title = element_text(size = 15), 
          axis.title = element_text(size=15), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          legend.text = element_text(size=15))

plot
```

Now, we will plot all samples in the dim-red space. 

```{r visualizing-umap-by-sample, message=F, fig.width=20}

library(RColorBrewer)

rownames(mat_red) <- spe$sample
mat_red_df <- as.data.frame(mat_red)
mat_red_df["sample"] <- rownames(mat_red)
mat_red_df_rand <- mat_red_df[sample(1:nrow(mat_red_df)),]
  
plot <- ggplot(mat_red_df_rand, aes(x=V1, y=V2, colour=sample)) +
    geom_point(size=0.05, alpha=0.5, show.legend=F) + 
    ggtitle("Sample") +
    scale_colour_manual(values = col_sample) +
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size=5), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"),
          legend.text = element_text(size=5))

plot
```

Now, we will plot the marker separately in the dim-red space. 

```{r visualizing-umap-by-marker, message=F, fig.width=20}
#mat_tmp <- rbind(mat, intensity_mat_lq_wo_zeros, morph_mat_clipped)
mat_tmp <- morph_mat_clipped[c("area", "solidity"),]

for (i in 1: nrow(mat_tmp)){
  marker <- rownames(mat_tmp)[i]
  mat_red_df <- as.data.frame(mat_red)
  mat_red_df["marker"] <- mat_tmp[i,]
  mat_red_df_rand <- mat_red_df[sample(1:nrow(mat_red_df)),]
  #mat_red_df_rand <- mat_red_df[order(mat_red_df["marker"], decreasing=T),]
    
  plot <- ggplot(mat_red_df_rand, aes(x=V1, y=V2, colour=marker)) +
      geom_point(size=0.05, alpha=0.2, show.legend=T) + 
      ggtitle(marker) +
      scale_colour_viridis_c() +
      theme(plot.title = element_text(size = 5), 
            axis.title = element_text(size=5), 
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank(), 
            panel.background = element_blank(), 
            axis.line = element_line(colour = "black"),
            legend.text = element_text(size=5))
  
  ggsave(filename=file.path(path, paste0("results/UMAP/annotated/markers/", marker , ".tiff")), width = 10, height = 5) #units = "in", device='tiff', dpi=500)
} 
```

Next, we will plot the tissue type separately in the dim-red space.

```{r visualizing-umap-by-tissuetype}

var <- "tissue"

rownames(mat_red) <- spe$sample_id
meta <- colData(spe)[match(rownames(mat_red), spe$sample_id),var]

samples <- unique(meta)

bin_col <- setNames(c(adjustcolor("gray90",alpha.f=1), "palegreen4"), c(FALSE,TRUE))

plot_list <- list()

for(i in 1: length(samples)){

  sample_binary <- meta == samples[i] 
  
  background <- as.data.frame(mat_red[!sample_binary,])
  foreground <- as.data.frame(mat_red[sample_binary,])
  plot_list[[i]] <- ggplot(background, aes(x=V1, y=V2) ) +
    geom_point(color="gray90", size=0.02) +
    geom_point(data=foreground, color="palegreen4", show.legend=F, size=0.02, alpha=0.25) +
    ggtitle(samples[i]) +
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size=5), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"))
}


plot_list[[1]]
plot_list[[2]]
```

Now, we will plot the clusters separately in the dim-red space. 

```{r visualizing-umap-by-marker, message=F, fig.width=20}

samples <- unique(celltype)

for(i in 1: length(samples)){

  sample_binary <- celltype == samples[i] 
  
  background <- as.data.frame(mat_red[!sample_binary,])
  foreground <- as.data.frame(mat_red[sample_binary,])
  plot <- ggplot(background, aes(x=V1, y=V2) ) +
    geom_point(color="gray90", size=0.02) +
    geom_point(data=foreground, color="palegreen4", show.legend=F, size=0.02, alpha=0.25) +
    ggtitle(samples[i]) +
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size=5), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"))
  
  ggsave(filename=file.path(path, paste0("results/UMAP/annotated/celltype/", samples[i] , ".tiff")), width = 10, height = 5, units = "in", device='tiff', dpi=500)
}

```

Now, we will plot the clusters separately in the dim-red space per PT and BM. 

```{r visualizing-umap-by-marker, message=F, fig.width=20}

celltype <- spe$celltype
mat_red_df <- as.data.frame(mat_red)
mat_red_df["tissue"] <- spe$tissue

samples <- unique(celltype)

for(i in 1: length(samples)){

  sample_binary <- celltype == samples[i] 
  
  background <- as.data.frame(mat_red_df[!sample_binary,])
  foreground <- as.data.frame(mat_red_df[sample_binary,])
  plot <- ggplot(background, aes(x=V1, y=V2) ) +
    geom_point(color="gray90", size=0.02) +
    geom_point(data=foreground, aes(x=V1, y=V2, colour=tissue), show.legend=F, size=0.02, alpha=0.25) +
    scale_colour_manual(values = col_tissue) +
    ggtitle(samples[i]) +
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size=5), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"))
  
  ggsave(filename=file.path(path, paste0("results/dim_reduction/UMAP_phenograph/clusters/", samples[i] , ".tiff")), width = 10, height = 5, units = "in", device='tiff', dpi=500)
}

```


Finally, we will visualize the data in the dimensionality reduced space and color the dots by the sample they belong to. 

```{r visualizing-umap-by-sample-single}

var <- "sample"
colData(spe) <- spe$sample
meta <- colData(spe)[match(rownames(mat_red), spe$sample),var]

samples <- unique(meta)

bin_col <- setNames(c(adjustcolor("gray90",alpha.f=1), "palegreen4"), c(FALSE,TRUE))

plot_list <- list()

for(i in 1: length(samples)){

  sample_binary <- meta == samples[i] 
  
  background <- as.data.frame(mat_red[!sample_binary,])
  foreground <- as.data.frame(mat_red[sample_binary,])
  plot_list[[i]] <- ggplot(background, aes(x=V1, y=V2) ) +
    geom_point(color="gray90", size=0.05) + 
    geom_point(data=foreground, color="palegreen4", show.legend=F, size=0.05, alpha=0.25) +
    ggtitle(samples[i]) +
    theme(plot.title = element_text(size = 5), 
          axis.title = element_text(size=5), 
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank(), 
          panel.background = element_blank(), 
          axis.line = element_line(colour = "black"))
}


plot_sublists <- split(plot_list, ceiling(seq_along(plot_list) / 33)) 

save_tiff <- function(sublist, j){
  plot <- plot_grid(plotlist = sublist, nrow=11, ncol=3) 
  ggsave(filename=file.path(path, paste("/results/UMAP/annotated/sample/sample_", j, ".tiff", sep="")), width = 7, height = 20, units = "in", device='tiff', dpi=500)
}

mapply(save_tiff, plot_sublists, 1:length(plot_sublists))
```

Next, we will visualize the cluster per sample and the sample per cluster as described [here](https://r-graph-gallery.com/48-grouped-barplot-with-ggplot2.html).
```{r barplot-cluster-per-sample, fig.width=18}
 # library
library(ggplot2)
library(tidyverse)

col_celltype<- col_celltype[order(as.integer(names(col_celltype)))]

colnames(mat) <- spe$sample
data <- data.frame(sample=colnames(mat), celltype)
data$freq <- 1

data_wide <- data %>% pivot_wider(names_from = c("celltype"), values_from = "freq", values_fn = sum, values_fill = 0)

write.csv(data_wide, file.path(path, "results/metadata/celltype-per-sample.csv"))

data_long <- data_wide[c(146:170),] %>% pivot_longer(cols = !sample, names_to = "celltype", values_to = "count") 

data_long$celltype <- factor(data_long$celltype, levels=levels(celltype))

 
# Stacked + percent
ggplot(data_long, aes(fill=celltype, y=count, x=sample)) + 
  ggtitle("Clusters per PT sample") +
  geom_bar(position="fill", stat="identity") + 
  scale_fill_manual(values = col_celltype) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```


```{r barplot-samples-per-cluster, fig.width=20}
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
col_sample = setNames(sample(col_vector_433, length(unique(data$sample))), unique(data$sample))

data_wide <- data %>% pivot_wider(names_from = c("sample"), values_from = "freq", values_fn = sum, values_fill = 0)

write.csv(data_wide, file.path(path, "results/metadata/samples-per-celltype.csv"))

data_long <- data_wide %>% pivot_longer(cols = !celltype, names_to = "sample", values_to = "count") 

 
# Stacked + percent
ggplot(data_long, aes(fill=sample, y=count, x=celltype)) + 
  ggtitle("Samples per celltype") +
  geom_bar(position="fill", stat="identity", show.legend = F) + 
  scale_fill_manual(values = col_sample) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

We will now visualize the tissues per cluster. 

```{r barplot-tissues-per-cluster, fig.width=20}

colnames(mat) <- spe$sample
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]

data <- data.frame(tissue=gsub(".*_*_", "", colnames(mat)), celltype)
data[data$tissue%in%"TU",]$tissue <- "PT"
data$freq <- 1
data_wide <- data %>% pivot_wider(names_from = c("tissue"), values_from = "freq", values_fn = sum, values_fill = 0)

write.csv(data_wide, file.path(path, "/results/metadata/tissues-per-celltype.csv"))

data_long <- data_wide %>% pivot_longer(cols = !celltype, names_to = "tissue", values_to = "count") 

 
# Stacked + percent
ggplot(data_long, aes(fill=tissue, y=count, x=celltype)) + 
  ggtitle("Samples per celltype") +
  geom_bar(position="fill", stat="identity", show.legend = T) + 
  scale_fill_manual(values = col_tissue) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

We will now visualize the clusters in a few samples to see if they make sense.

```{r visualize-clusters-in-image, message=FALSE, fig.width=15}
library(cytomapper)

files <- list.files(file.path(path, "masks_temp"))

for(i in 1: length(files)){
  
  masks <- loadImages(file.path(path, "masks_temp", files[i]), as.is = TRUE)
  
  # tmp <- sub('.*clust_', '', files[i])
  # names(masks) <- sub("\\.tif.*", "", tmp)
  # c <- sub("\\_clust.*", "", files[i])
  
  c <- "Tumor_1"
  mcols(masks) <- DataFrame(sample_id = names(masks))
  
  
  plotCells(masks,
            object = spe,
            cell_id = "ObjectNumber", img_id = "sample_id",
            colour_by = "celltype",
            colour = list(celltype = metadata(spe)$color_vector$col_celltype),
            display = "single",
            save_plot = list(filename = file.path(path, "results/colored_masks/max_sample_per_cluster/", paste0("all_", files[i], "f"))),
            legend = NULL)


  col_celltype_bin <- setNames(c("red", "white"), c('yes', 'no'))
  spe$binary <- 'no'
  spe[,spe$celltype == c]$binary <- 'yes'


  plotCells(masks,
            object = spe,
            cell_id = "ObjectNumber", img_id = "sample_id",
            colour_by = "binary",
            colour = list(binary = col_celltype_bin),
            display="single",
            save_plot = list(filename = file.path(path, "results/colored_masks/max_sample_per_cluster", paste0(files[i], "f"))),
            legend=NULL)

}

```

