---
title: "UMAP and histogram on matrices"
output: html_document
date: '2022-12-28'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
```

In this RMD file, we will identify cells that swam off between IF and IMC and exclude those from further downstream analysis. First we will read in the single-cell data which were based on masks without expansion to make sure that we do not catch signal from neighboring cells.

```{r read-data}

path <- "/mnt/Multimodal_Imaging_Daria/_Data_Analysis/_tmp_daria/Image_analysis/20230112_DIMR_Ilastik/20230202_sc_data"

spe <- readRDS(file.path(path,"data/spe_no-dil.rds"))

```


Then we will generate next generate a matrix for the spatial experiment object and exclude IF markers DAPI, GD2 and CD56 as well as IMC marker CD274, as this one was not background corrected and first exclude all cells that are zero for all remaining markers. Then, we will examine whether there are still "ghosts" left by clustering the reduced matrix. We will use mean-80 instead of mean intensity, because cells might have a low mean intensity due to their size, which should not be excluded. As there are sometimes cells, without nuclear staining, like clPARP+ cells, we will include all IMC markers (except for CD274) and DAPI for clustering. 

```{r generate-dataframes, message=FALSE, fig.height=7}
library(bruceR)

# Remove segmentation artifacts
sum(spe$area < 25)
spe <- spe[,spe$area >= 25]


intensity_mat <- assay(spe, "exprs")
colnames(intensity_mat) <- spe$sample

#use mean-80 intensity to avoid losing big cells
intensity_mat_mean_80 <- intensity_mat[grepl("mean-80", rownames(intensity_mat)),]

#exclusion of all-zero cells
intensity_mat_bg_corrected <- intensity_mat_mean_80[!grepl("CD274|2IF_GD2|3IF_CD56|DAPI", rownames(intensity_mat_mean_80)),]
non_zeros <- as.logical(colSums(intensity_mat_bg_corrected)!=0)

length(non_zeros[non_zeros==FALSE])

spe <- spe[, non_zeros]
mat <- intensity_mat_mean_80[, non_zeros]
cell_id <- colnames(spe)

#Consideration of only nuclear channels for IF for identification of further lost cells
mat <- mat[!grepl("2IF_GD2|3IF_CD56", rownames(mat)),]

```


In a next step, we will plot a single-cell heatmap using complex heatmap. 

```{r single-cell-heatmap, message=FALSE, fig.height=20}
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(RColorBrewer)
library(paletteer)

mat <- mat

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_74 = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]

col_sample = setNames(sample(col_vector_433, length(unique(spe$sample))), unique(spe$sample))

set.seed(221228)
rand_cells <- sample(seq_len(ncol(mat)), 2000)

column_ha = HeatmapAnnotation(sample = colnames(mat[,rand_cells]), col=list(sample=col_sample), show_legend=F)
Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap",
        top_annotation = column_ha, 
        show_column_dend = F,
        show_column_names=F,
        col=viridis(100)
        )
```

We can already see a cluster of cells expressing DAPI but not IMC markers. We can however not exclude that those cells that have a weak Iridium staining are showing the signal from neighboring cells. 

We will now cluster the data to identify cells that swam off. 

```{r phenograph-clustering}
library(FastPG)
library(parallel)

n_threads <- detectCores()

mat <- t(mat)

out <- FastPG::fastCluster(data=mat, k=45, num_threads=n_threads)
clusters <- factor(out$communities)
saveRDS(clusters, file.path(path, "data/clusters-int-1px-mean_identify-lost-cells.rds"))

```

Next we will look at the single cell heatmap ordered by the identified phenograph clusters. 

```{r single-cell-heatmap-clusters, message=FALSE, fig.height=17}
library(ComplexHeatmap)
library(viridis)
library(circlize)
library(RColorBrewer)
library(paletteer)

n <- length(unique(clusters))
col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]
col_clusters <- setNames(sample(col_vector_433, n), unique(clusters))

col_marker = colorRamp2(c(0, 2.5, 0.5), c("blue", "white", "red"))

set.seed(221228)
mat <- t(mat)
rand_cells <- sample(seq_len(ncol(mat)), 2000)

column_ha = HeatmapAnnotation(cluster = clusters[rand_cells], 
                              DNA = mat["193Ir-DNA1_Ir193_mean-80", rand_cells],
                              col=list(cluster=col_clusters, DNA=col_marker), 
                              show_legend=F)


Heatmap(mat[,rand_cells], 
        column_title = "Single-cell heatmap with phenograph clusters (-1px -mean)",
        top_annotation = column_ha, 
        cluster_columns=F,
        column_order= order(clusters[rand_cells], decreasing=F),
        show_column_dend = F,
        show_column_names=F,
        col=viridis(100)
        )
```

Next, we will look at the mean marker expression per cluster. 

```{r ingle-cell-heatmap-clusters-mean, message=FALSE, fig.height=17}
library(scuttle)



mean <- aggregate(t(mat), list(clusters), mean)
mean_t <- t(mean)
colnames(mean_t) <- mean[,"Group.1"]

column_ha = HeatmapAnnotation(cluster = mean[,"Group.1"], 
                              ncells=anno_barplot(as.data.frame(table(clusters))[,"Freq"], height = unit(3, "cm")),
                              col=list(cluster=col_clusters), 
                              show_legend=T)

mean_t <- t(mean[,2:ncol(mean)])
colnames(mean_t) <- mean[,"Group.1"]

Heatmap(mean_t, 
        column_title = "Cluster-means heatmap with phenograph clusters (-1px -mean)",
        top_annotation = column_ha, 
        cluster_columns=T,
        show_column_dend = F,
        show_column_names=T,
        show_row_names=T,
        col=viridis(100)
        )


```
We can see that cluster 44 are most probably the sticky cells, which are positive for everything. Cluster 0 are most probably cells that swam off between IF and IMC and are hence negative for everything except for DAPI. We will check which sample has the highest presence of this cluster.

```{r identify-zeros-clusters, fig.width=20}

c <- "0"

data <- data.frame(sample=colnames(mat), clusters)
data$freq <- 1

data_wide <- data %>% pivot_wider(names_from = c("clusters"), values_from = "freq", values_fn = sum, values_fill = 0)
data_long <- data_wide %>% pivot_longer(cols = !sample, names_to = "cluster", values_to = "count") 

clust <- data_long[data_long$cluster==c,]
clust <- clust[order(clust$count, decreasing=T), ]
max_sample <- clust$sample[1]

df <- as.data.frame(t(mat))
df$cluster <- clusters
df$sample <- colnames(mat)
rownames(df) <- cell_id


rownames(df)[df$sample==max_sample & df$cluster ==c]


```
Sample 20220316_04-0169_BM_N_ROI_001 has the highest presence of cluster 0. Let's now color its mask by the clusters. Therefore we will just copy the img and mask of that sample into the "img" and "masks" folder as reading in all images takes too long. 

```{r visualize-clusters-in-image, message=FALSE, fig.width=15}
library(cytomapper)

spe$pg_clusters <- clusters

masks <- loadImages(file.path(path, "masks_temp"), as.is = TRUE)

mcols(masks) <- DataFrame(sample_id = names(masks))


plotCells(masks,
          object = spe, 
          cell_id = "ObjectNumber", img_id = "sample_id",
          colour_by = "pg_clusters",
          colour = list(pg_clusters = col_clusters),
          display = "single",
          save_plot = list(filename = file.path(path, "data/20220316_04-0169_BM_N_ROI_001_cluster_image.png")),
          legend = NULL)

c = "0"
celltype <- spe[,spe$pg_clusters == c]

#Number of excluded cells
ncol(celltype)

plotCells(masks,
          object = celltype, 
          cell_id = "ObjectNumber", img_id = "sample_id",
          colour_by = "pg_clusters",
          colour = list(celltype = c(celltype = "red")),
          missing_colour = "white",
          display="single",
          save_plot = list(filename = file.path(path, paste0("data/20220316_04-0169_BM_N_ROI_001_cluster_", c, ".png"))),
          legend=NULL)

```

By overlaying the DAPI image, the Iridium image and the binary mask, we see that cluster 0 is the cluster of lost cells (n=30866 -2% of all cells - 571images, i.e. 54 cells per image). We will exclude it and then we will perform dimensionality reduction by a UMAP. We will exclude those cells in the single-cell data that was computed based on the masks expanded by 1 pixel and on those without expansion.

```{r exclude-lost-cells-in-1-px}

spe <- spe[, spe$pg_clusters!="0"]
saveRDS(spe, file.path(path, "data/spe_no-dil_wo-ghosts.rds"))

spe_1px <- readRDS(file.path(path,"data/spe_1px.rds"))
spe_1px <- spe_1px[,colnames(spe)]

saveRDS(spe_1px, file.path(path, "data/spe_1px_wo-ghosts.rds"))
```

