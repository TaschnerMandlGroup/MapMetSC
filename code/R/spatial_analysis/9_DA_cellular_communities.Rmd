---
title: "Differential abundance testing with limma-voom"
output: html_document
date: '2023-08-19'
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "120%")
```

## Load data

First, we will find paired samples. 

```{r selection-paired-sample, message=FALSE}
library(SpatialExperiment)
library(CATALYST)
library(cowplot)
library(ggplot2)
library(diffcyt)
library(flowCore)
library(readxl)
library(scater)
library(dplyr)
library(tidyr)

path <- "/mnt/Multimodal_Imaging_Daria/PIPELINE/NEWEST_RESULTS"
spe <- readRDS(file.path(path,"results/spatial_analysis/spe_CNs.rds"))
```

## Subset dataset

We will first read in the previously generated `SpatialExperiment` object and transform it into a catalyst compatible object.

```{r read-data-pheno, message=FALSE}

spe$tmp <- "na"

keep_rows <- rowData(spe)$use_channel 
keep_cols <- spe$celltype != "other" & spe$tissue=="PT" & (spe$timepoint=="DE") & spe$metacluster == "tumor"

sce <- SingleCellExperiment(assays=list(counts=assay(spe, "counts")[keep_rows, keep_cols], exprs=assay(spe, "counts")[keep_rows, keep_cols]))

sce$control <- factor(spe[keep_rows, keep_cols]$control)
sce$cluster_id <- factor(spe[keep_rows, keep_cols]$celltype)
sce$patient <- factor(spe[keep_rows, keep_cols]$study_id)
sce$tissue <- factor(spe[keep_rows, keep_cols]$tissue)
sce$metacluster <- factor(spe[keep_rows, keep_cols]$metacluster)
sce$border <- factor(spe[keep_rows, keep_cols]$border)

sce$mna <- factor(spe[keep_rows, keep_cols]$MYCN_amp)
mna <- as.vector(sce$mna)
mna <- replace(x = mna, list =  mna %in% c(1), values =  'MNA')
mna <- replace(x = mna, list =  mna %in% c(3), values =  'het')
mna <- replace(x = mna, list =  mna %in% c(0), values =  'nMNA')
mna <- replace(x = mna, list =  mna %in% c(9), values =  'unknown')
sce$mna <- as.factor(mna)

sce$progress <- factor(spe[keep_rows, keep_cols]$progression)
progress <- as.vector(sce$progress)
progress <- replace(x = progress, list =  progress==0, values =  'NoProg')
progress <- replace(x = progress, list =  progress==1, values =  'Prog')
sce$progress <- as.factor(progress)

sce$timepoint <- spe[keep_rows, keep_cols]$timepoint
sce$timepoint <- factor(sce$timepoint)

sce$condition <- sce$border 

# Add celltype information to metadata
metadata(sce)$cluster_codes <- data.frame(celltype = factor(spe[keep_rows, keep_cols]$celltype))

sce$sample_id <- factor(paste0(sce$progress, "_", sce$mna, "_", spe[keep_rows, keep_cols]$study_id, "_", spe[keep_rows, keep_cols]$fm_id, "_", sce$tissue))

```

## Plot overview of cohort

Differential analysis of cell population abundance compares the proportions of cell types across experimental conditions and aims to highlight populations that are present at different ratios. First, we calculate two tables: one that contains cell counts for each sample and population and one with the corresponding  proportions of cell types by sample.  The proportions are used only for plotting, since the statistical modeling takes the cell counts by cluster and sample as input.

For each sample, we plot its PBMC cell type composition represented with colored bars, where the size of a given stripe reflects the proportion of the corresponding cell type in a given sample (Figure \@ref(fig:diff-freqs-plot-props-barplot)).

```{r diff-freqs-plot-props-barplot, fig.cap = "Relative abundance of the 8 PBMC populations in each sample (x-axis), in the PBMC dataset, represented with a barplot. The 8 cell populations are a result of manual merging of the 20 FlowSOM metaclusters", fig.width=20, fig.height=10}
library(RColorBrewer)
set.seed(20231103)
p <- plotAbundances(sce, k = "celltype", by = "sample", col_clust=T, k_pal=brewer.pal(6, "Set3"), 
                    linkage="ward.D", distance="manhattan") 

clustered_samples <- sapply(strsplit(levels(p$data$sample_id), "_"), function(x) paste(x[4], x[5], sep = "_"))

#Dendogram
set.seed(20231103)
wide_df <- p$data %>%
  select(-condition) %>%
  pivot_wider(names_from = cluster_id, values_from = Freq)

wide_df <- data.frame(wide_df)
rownames(wide_df) <- wide_df$sample_id
wide_df <- wide_df %>% select(-sample_id)

dist_matrix <- dist(wide_df, method = "manhattan")
hc <- hclust(dist_matrix, method = "ward.D")

#Extract clusters of cellular communities
cellular_communities <- as.data.frame(cutree(hc, k = 2)[levels(p$data$sample_id)])
colnames(cellular_communities) <- c("community_cluster")
cluster_names <- setNames(order(unique(cellular_communities$community_cluster)), c(1:max(cellular_communities$community_cluster)))
cellular_communities$community_cluster <- recode(cellular_communities$community_cluster, !!!cluster_names)

setEPS()
postscript(file.path(path, "results/spatial_analysis/DA_analysis/dendogram_PT_DE_samples_CNs.eps"), height=12, width=30)
plot(hc)
dev.off()

setEPS()
postscript(file.path(path, "results/spatial_analysis/DA_analysis/barplot_PT_DE_samples_CNs.eps"), height=12, width=20)
p
dev.off()
```


Next, we will plot metadata on top of the clustered barplot. First, we will define the color code for the metadata. Find all built-in R color names [here](https://www.farb-tabelle.de/de/farbtabelle.htm). The [paletteer package](https://r-charts.com/color-palettes/) offers a wide range of color palettes.  

```{r define-color-code, message=FALSE}
library(ComplexHeatmap)
library(RColorBrewer)
library(paletteer)
library(bruceR)
library(circlize)
library(viridis)

meta_path <- file.path(path, '20231128_metadata_complete.csv')

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_74 = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]

meta_all = read.csv(meta_path)
meta_all <- meta_all[order(meta_all$Study_ID),] #order by study-id

exclude <- replace(x = meta_all$exclude, list =  !meta_all$exclude %in% c('no', 'maybe'), values =  'partially')

col_sample = setNames(sample(col_vector_433, length(unique(meta_all$Sample))), unique(meta_all$Sample))
col_puncture_side = setNames(brewer.pal(length(unique(meta_all$Puncture_side)), 'Set3'), unique(meta_all$Puncture_side))
col_staining_batch = setNames(viridis(length(unique(meta_all$Staining_date))), sort(unique(meta_all$Staining_date)))
col_stainer = setNames(c('#a6611a', '#dfc27d', '#80cdc1', '#018571'), unique(meta_all$Stainer))
col_imc_batch = setNames(viridis(length(unique(meta_all$IMC_date))), sort(unique(meta_all$IMC_date)))
col_imc_score = colorRamp2(c(min(meta_all$IMC_score, na.rm = TRUE), max(meta_all$IMC_score, na.rm = TRUE)/2, max(meta_all$IMC_score, na.rm = TRUE)), viridis(3)) 
col_study_id = setNames(sample(col_vector_433, length(unique(meta_all$Study_ID))), unique(meta_all$Study_ID))
col_DE_year = setNames(viridis(length(unique(meta_all$DE_date))), sort(unique(meta_all$DE_date)))
col_timepoint = setNames(c('#7fc97f', '#beaed4', '#386cb0', '#ffff99', '#386cb0'), unique(meta_all$Timepoint)) #'#fdc086'
col_aberrations = setNames(c('#a6611a','#018571','#80cdc1','#f5f5f5'), c(0,1,2,9))
col_stages = setNames(c('#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c'), unique(meta_all$stage4))
col_efs_dur = colorRamp2(c(min(meta_all$efs_dur, na.rm = TRUE), max(meta_all$efs_dur, na.rm = TRUE)/2, max(meta_all$efs_dur, na.rm = TRUE)), viridis(3))
col_tissue = setNames(c('aquamarine4','brown'), unique(meta_all$Tissue))
col_control = setNames(c('gray77', 'mediumseagreen'), unique(meta_all$control))
col_exclude = setNames(c('#018571','#a6611a','#80cdc1'), unique(exclude))
col_progress = setNames(c('gray77', 'palegreen3', 'firebrick1'), c('n.a.', 0, 1))
#col_age_diag = colorRamp2(c(min(meta_all$age_at_diag, na.rm = TRUE), max(meta_all$age_at_diag, na.rm = TRUE)/2, max(meta_all$age_at_diag, na.rm = TRUE)), viridis(3))
col_age_diag = colorRamp2(c(min(meta_all$age_at_diag, na.rm = TRUE), (quantile(meta_all$age_at_diag, 0.95, na.rm = TRUE)-min(meta_all$age_at_diag, na.rm = TRUE))/2, quantile(meta_all$age_at_diag,0.95, na.rm = TRUE)), viridis(3))
col_therapy = setNames(c('#a6611a', '#018571'), c('RAPID COJEC', 'MOD. N7'))
```

Now, we will plot an overview of the cohort.

```{r overview-cohort, message=FALSE, fig.height=25}

rownames(meta_all) <- paste0(meta_all$Sample, "_", meta_all$Tissue)
meta_all <- meta_all[clustered_samples,]

setEPS()
postscript(file.path(path, "results/spatial_analysis/DA_analysis/PT_DE_annotation_bar.eps"), height=30, width=30)

columnAnnotation(control=meta_all$control, col=list(control=col_control)) %v%
columnAnnotation(sample=meta_all$Sample, col=list(sample=col_sample), annotation_legend_param = list(sample = list(grid_height=unit(0.05, "cm"), labels_gp = gpar(fontsize = 5)))) %v%
#columnAnnotation(exclusion=exclude, col=list(exclusion=col_exclude)) %v%
columnAnnotation(imc_score=meta_all$IMC_score, col=list(imc_score=col_imc_score))  %v%
columnAnnotation(staining_batch=meta_all$Staining_date, col=list(staining_batch=col_staining_batch)) %v%
columnAnnotation(stainer=meta_all$Stainer, col=list(stainer=col_stainer)) %v%
columnAnnotation(imc_batch=meta_all$IMC_date, col=list(imc_batch=col_imc_batch)) %v%
columnAnnotation(D_year=meta_all$DE_date, col=list(D_year=col_DE_year))  %v%
columnAnnotation(study_id=meta_all$Study_ID, col=list(study_id=col_study_id))  %v%
columnAnnotation(timepoint=meta_all$Timepoint, col=list(timepoint=col_timepoint))  %v%
columnAnnotation(tissue=meta_all$Tissue, col=list(tissue=col_tissue)) %v%
columnAnnotation(stage=meta_all$stage4, col=list(stage=col_stages)) %v%
columnAnnotation(progression=meta_all$efs, col=list(progression=col_progress))  %v%
columnAnnotation(efs_dur=meta_all$efs_dur, col=list(efs_dur=col_efs_dur)) %v%

columnAnnotation(X1p_loss=meta_all$X1p_loss, col=list(X1p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X1q_gain=meta_all$X1q_gain, col=list(X1q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X1q_loss=meta_all$X1q_loss, col=list(X1q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X2p_gain=meta_all$X2p_gain, col=list(X2p_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X3p_loss=meta_all$X3p_loss, col=list(X3p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X3q_loss=meta_all$X3q_loss, col=list(X3q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X4p_loss=meta_all$X4p_loss, col=list(X4p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X6q_loss=meta_all$X6q_loss, col=list(X6q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X7q_gain=meta_all$X7q_gain, col=list(X7q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(PTPRD_del=meta_all$PTPRD_del, col=list(PTPRD_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(CDKN2AB_del=meta_all$CDKN2AB_del, col=list(CDKN2AB_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X11q_loss=meta_all$X11q_loss, col=list(X11q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X12q_gain=meta_all$X12q_gain, col=list(X12q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X14q_loss=meta_all$X14q_loss, col=list(X14q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X17p_loss=meta_all$X17p_loss, col=list(X17p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X17q_gain=meta_all$X17q_gain, col=list(X17q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X19p_loss=meta_all$X19p_loss, col=list(X19p_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X19q_loss=meta_all$X19q_loss, col=list(X19q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X22q_loss=meta_all$X22q_loss, col=list(X22q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(CDKN2AB_del=meta_all$CDKN2AB_del, col=list(CDKN2AB_del=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X11q_loss=meta_all$X11q_loss, col=list(X11q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X12q_gain=meta_all$X12q_gain, col=list(X12q_gain=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(X14q_loss=meta_all$X14q_loss, col=list(X14q_loss=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(MYCN_amp=meta_all$MYCN_amp, col=list(MYCN_amp=col_aberrations)) %v% #annotation_legend_param = list(MYCN_amp = list(title='aberration', 
                                                                                                              #labels = c('no','yes','het'))))  %v%
                                                                                                              #labels = c('no', 'yes', 'het', 'NA'))))  %v%
columnAnnotation(TERT_rear=meta_all$TERT_rear, col=list(TERT_rear=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(ATRX_del=meta_all$ATRX_del, col=list(ATRX_del=col_aberrations), show_legend=FALSE) %v% 
columnAnnotation(ALK_amp=meta_all$ALK_amp, col=list(ALK_amp=col_aberrations), show_legend=FALSE) %v%
columnAnnotation(ALK_mut=meta_all$ALK_mut, col=list(ALK_mut=col_aberrations), show_legend=FALSE) %v%

columnAnnotation(age=meta_all$age_at_diag, col=list(age=col_age_diag)) %v%
columnAnnotation(therapy=meta_all$therapy, col=list(therapy=col_therapy)) 


dev.off()

```

