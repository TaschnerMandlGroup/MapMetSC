---
title: "Visualize metadata"
output: html_document
date: '2022-08-15'
---

```{r setup, include=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width = "120%")


```

# Visualize metadata with complex heatmap

Complex Heatmap allows visualization of complex heatmap as explained in these [videos](https://www.youtube.com/watch?v=NlMga8pK2Pw) and [notebooks](https://github.com/brandonyph/ComplexHeatmap_Walkthrough). We will try to show the cohort metadata together with the the heatmaps generated in clustering.RMD. 

## Load data

We will first read in the previously generated `SpatialExperiment` object and
sample 2000 cells to visualize cluster membership.

```{r read-data-pheno, message=FALSE}
library(SpatialExperiment)
library(ComplexHeatmap)
library(RColorBrewer)
library(dittoSeq)
library(paletteer)
library(bruceR)
library(circlize)
library(viridis)

path <- "/mnt/Multimodal_Imaging_Daria/_Data_Analysis/_tmp_daria/Image_analysis/20220723_Steinbock_Mesmer_IFbased"
spe <- readRDS(file.path(path,"data/spe.rds"))

# Sample cells
set.seed(220619)
cur_cells <- sample(seq_len(ncol(spe)), 2000)

#Scale expression between 0 and 1 for later visualization
assay(spe, "scaled_exprs") <- t(apply(assay(spe, "exprs"), 1, RESCALE, to=0:1))
```

First, we will define the color code for the metadata. Find all built-in R color names [here](https://www.farb-tabelle.de/de/farbtabelle.htm). The [paletteer package](https://r-charts.com/color-palettes/) offers a wide range of color palettes.  

```{r define-color-code, message=FALSE}

qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector_74 = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))

col_vector_433 = colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)]

meta_all = read.csv(file.path(path, "metadata_all.csv"))
meta_all <- meta_all[order(meta_all$Study_ID),] #order by study-id

DE_year <- sub("-.*", "", meta_all$DE_date)

col_sample = setNames(sample(col_vector_433, length(unique(meta_all$Sample))), unique(meta_all$Sample))
col_puncture_side = setNames(brewer.pal(length(unique(meta_all$Puncture_side)), 'Set3'), unique(meta_all$Puncture_side))
col_staining_batch = setNames(sample(col_vector_74, length(unique(meta_all$Staining_date))), unique(meta_all$Staining_date))
col_stainer = setNames(c('#fc8d59', '#ffffbf', '#91cf60'), unique(meta_all$Stainer))
col_imc_batch = setNames(sample(col_vector_74, length(unique(meta_all$IMC_date))), unique(meta_all$IMC_date))
col_imc_score = colorRamp2(c(min(meta_all$IMC_score, na.rm = TRUE), max(meta_all$IMC_score, na.rm = TRUE)/2, max(meta_all$IMC_score, na.rm = TRUE)), c("red", "white", "blue")) 
col_study_id = setNames(sample(col_vector_74, length(unique(meta_all$Study_ID))), unique(meta_all$Study_ID))
col_DE_year = setNames(paletteer_d("dichromat::BluetoDarkOrange_18", length(unique(DE_year)), -1), unique(DE_year))
col_timepoint = setNames(c('#7fc97f', '#beaed4', '#fdc086' , '#ffff99'), unique(meta_all$Timepoint))
col_aberrations = setNames(c('#018571','#a6611a','#80cdc1','#f5f5f5'), c(0,1,3,9))
col_stages = setNames(colors()[c(545,622,525,74)], unique(meta_all$stage4))
col_efs_dur = colorRamp2(c(min(meta_all$efs_dur, na.rm = TRUE), max(meta_all$efs_dur, na.rm = TRUE)/2, max(meta_all$efs_dur, na.rm = TRUE)), paletteer_c("ggthemes::Red-Green Diverging", 3))
col_progress = setNames(c('red3', 'royalblue'), unique(spe$efs))
```

Now, we will plot an overview of the cohort.

```{r overview-cohort, message=FALSE, fig.height=15}
columnAnnotation(study_id=meta_all$Study_ID, col=list(study_id=col_study_id))  %v%
columnAnnotation(sample=meta_all$Sample, col=list(sample=col_sample), annotation_legend_param = list(sample = list(grid_height=unit(0.05, "cm"), labels_gp = gpar(fontsize = 5)))) %v%
  columnAnnotation(puncture_side=meta_all$Puncture_side, col=list(stainer=col_puncture_side)) %v%
  columnAnnotation(staining_batch=meta_all$Staining_date, col=list(staining_batch=col_staining_batch)) %v%
  columnAnnotation(stainer=meta_all$Stainer, col=list(stainer=col_stainer)) %v%
  columnAnnotation(imc_batch=meta_all$IMC_date, col=list(imc_batch=col_imc_batch)) %v%
  columnAnnotation(imc_score=meta_all$IMC_score, col=list(imc_score=col_imc_score))  %v%
  columnAnnotation(DE_year=meta_all$Staining_date, col=list(staining_batch=col_staining_batch)) %v%
  columnAnnotation(timepoint=meta_all$Timepoint, col=list(timepoint=col_timepoint))  %v%
  columnAnnotation(stage=meta_all$stage4, col=list(stage=col_stages)) %v% 
  columnAnnotation(efs_dur=meta_all$efs_dur, col=list(efs_dur=col_efs_dur)) %v% 
  columnAnnotation(progression=meta_all$efs, col=list(progression=col_progress))  %v%
  columnAnnotation(MYCN_amp=meta_all$MYCN_amp, col=list(MYCN_amp=col_aberrations), annotation_legend_param = list(MYCN_amp = list(title='aberration', labels = c('no', 'yes', 'het', 'NA'))))  %v%
  columnAnnotation(ALK_amp=meta_all$ALK_amp, col=list(ALK_amp=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(ALK_amp=meta_all$ALK_amp, col=list(ALK_amp=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(ALK_mut=meta_all$ALK_mut, col=list(ALK_mut=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(ATRX_del=meta_all$ATRX_del, col=list(ATRX_del=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(TERT_rear=meta_all$TERT_rear, col=list(TERT_rear=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(X1ploss=meta_all$X1p_loss, col=list(X1ploss=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(X1qgain=meta_all$X1q_gain, col=list(X1qgain=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(X11qloss=meta_all$X11q_loss, col=list(X11qloss=col_aberrations), show_legend=FALSE) %v%
  columnAnnotation(X17qgain=meta_all$X17q_gain, col=list(X17qgain=col_aberrations), show_legend=FALSE) 
```

We will visualize the PG- and SOM-heatmamps showing the number of cells per cluster in an annotation barplot.

Let's start with the Phenograph clusters.

```{r rphenograph-clustering-2, message=FALSE}
dittoDimPlot(spe, var = "pg_clusters_corrected", 
             reduction.use = "UMAP_harmony", size = 0.2,
             do.label = TRUE) +
    ggtitle("Phenograph clusters expression on UMAP, integrated cells")
```


```{r phenograph-heatmap-2-allcells-mean, message=FALSE, fig.height=7}
library(scuttle)

sce <- as(spe, "SingleCellExperiment")

cluster_mean <- aggregateAcrossCells(sce,
                                    ids = sce$pg_clusters_corrected,
                                    statistics="mean",
                                    use.assay.type = "counts")
assay(cluster_mean, "exprs") <- asinh(counts(cluster_mean))
assay(cluster_mean, "scaled_exprs") <- t(apply(assay(cluster_mean, "exprs"), 1, RESCALE, to=0:1))


col_pg = setNames(dittoColors(1)[1:length(unique(sce$pg_clusters_corrected))], 
                sort(unique(sce$pg_clusters_corrected)))

column_annot = HeatmapAnnotation(clusters=colData(cluster_mean)$pg_clusters_corrected, 
                                 ncells=anno_barplot(colData(cluster_mean)$ncells, height = unit(3, "cm")),
                                 col=list(clusters=col_pg))

#not scaled
dittoHeatmap(cluster_mean, genes = rownames(sce)[rowData(sce)$use_channel],
            assay = "exprs", scale = "none",
            column_title = "Phenograph clusters on integrated cells (unscaled)", 
            heatmap.colors = viridis(100),
            cluster_cols=TRUE,
            show_colnames= TRUE,
            show_column_dend = FALSE,
            complex=TRUE,
            top_annotation=column_annot)
            

#scaled
dittoHeatmap(cluster_mean, genes = rownames(sce)[rowData(sce)$use_channel],
            assay = "scaled_exprs", scale = "none",
            column_title = "Phenograph clusters on integrated cells (scaled)",
            heatmap.colors = viridis(100),
            cluster_cols=TRUE,
            show_colnames= TRUE,
            show_column_dend = FALSE,
            complex=TRUE,
            top_annotation=column_annot)

#rm(sce)
#rm(cluster_mean)

```

Next, we want to look at the integrated single-cell heatmap showing metadata. 


```{r phenograph-heatmap-2-scale, message=FALSE, fig.height=7}

column_annot = HeatmapAnnotation(clusters=colData(spe[,cur_cells])$pg_clusters_corrected, 
                                 stages=spe[,cur_cells]$stage,
                                 MYCN_amp=spe[,cur_cells]$MYCN_amp,
                                 col=list(clusters=col_pg, stages=col_stages, MYCN_amp=col_aberrations))


dittoHeatmap(spe[,cur_cells], 
             genes = rownames(spe)[rowData(spe)$use_channel],
             assay = "scaled_exprs", 
             scale="none",
             heatmap.colors = viridis(100), 
             top_annotation=column_annot,
             column_order = order(colData(spe[,cur_cells])$pg_clusters_corrected),
             show_column_dend=FALSE,
             complex=TRUE)

```

Now we will do the same for the SOM clusters.

```{r flowSOM-clustering-2, message=FALSE}
dittoDimPlot(spe, var = "som_clusters_corrected", 
             reduction.use = "UMAP_harmony", size = 0.2,
             do.label = TRUE) +
    ggtitle("SOM clusters expression on UMAP, integrated cells")
```


```{r flowSOM-heatmap-2-allcells-mean, message=FALSE, fig.height=7}

sce <- as(spe, "SingleCellExperiment")

cluster_mean <- aggregateAcrossCells(sce,
                                    ids = sce$som_clusters_corrected,
                                    statistics="mean",
                                    use.assay.type = "counts")
assay(cluster_mean, "exprs") <- asinh(counts(cluster_mean))
assay(cluster_mean, "scaled_exprs") <- t(apply(assay(cluster_mean, "exprs"), 1, RESCALE, to=0:1))


col_som = setNames(dittoColors(1)[1:length(unique(sce$som_clusters_corrected))], 
                sort(unique(sce$som_clusters_corrected)))

column_annot = HeatmapAnnotation(clusters=colData(cluster_mean)$som_clusters_corrected, 
                                 ncells=anno_barplot(colData(cluster_mean)$ncells, height = unit(3, "cm")),
                                 col=list(clusters=col_som))

#not scaled
dittoHeatmap(cluster_mean, genes = rownames(sce)[rowData(sce)$use_channel],
            assay = "exprs", scale = "none",
            column_title = "FlowSOM clusters on integrated cells (unscaled)", 
            heatmap.colors = viridis(100),
            cluster_cols=TRUE,
            show_colnames= TRUE,
            show_column_dend = FALSE,
            complex=TRUE,
            top_annotation=column_annot)
            

#scaled
dittoHeatmap(cluster_mean, genes = rownames(sce)[rowData(sce)$use_channel],
            assay = "scaled_exprs", scale = "none",
            column_title = "FlowSOM clusters on integrated cells (scaled)",
            heatmap.colors = viridis(100),
            cluster_cols=TRUE,
            show_colnames= TRUE,
            show_column_dend = FALSE,
            complex=TRUE,
            top_annotation=column_annot)

#rm(sce)
#rm(cluster_mean)

```


```{r flowSOM-heatmap-2-scale, message=FALSE, fig.height=7}

column_annot = HeatmapAnnotation(clusters=colData(spe[,cur_cells])$som_clusters_corrected, 
                                 stages=spe[,cur_cells]$stage,
                                 MYCN_amp=spe[,cur_cells]$MYCN_amp,
                                 col=list(clusters=col_pg, stages=col_stages, MYCN_amp=col_aberrations))

dittoHeatmap(spe[,cur_cells], 
             genes = rownames(spe)[rowData(spe)$use_channel],
             assay = "scaled_exprs", 
             scale="none",
             heatmap.colors = viridis(100), 
             top_annotation=column_annot,
             column_order = order(colData(spe[,cur_cells])$som_clusters_corrected),
             show_column_dend=FALSE,
             complex=TRUE)

```

```{r phenotyping-save-object}
saveRDS(spe, file.path(path,"data/spe.rds"))
```

## Session Info

<details>
   <summary>SessionInfo</summary>
   
```{r, echo = FALSE}
sessionInfo()
```
</details>